

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>algo_engine.base.market_utils_posix &mdash; PyAlgoEngine 0.8.0.post5 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=78239c4e"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            PyAlgoEngine
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../setup.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apis.html">APIs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PyAlgoEngine</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">algo_engine.base.market_utils_posix</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for algo_engine.base.market_utils_posix</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">abc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ctypes</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">RawValue</span><span class="p">,</span> <span class="n">RawArray</span><span class="p">,</span> <span class="n">Condition</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">overload</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Self</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">LOGGER</span><span class="p">,</span> <span class="n">PROFILE</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LOGGER</span><span class="o">.</span><span class="n">getChild</span><span class="p">(</span><span class="s1">&#39;MarketUtils&#39;</span><span class="p">)</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TransactionSide&#39;</span><span class="p">,</span> <span class="s1">&#39;OrderType&#39;</span><span class="p">,</span>
           <span class="s1">&#39;MarketData&#39;</span><span class="p">,</span> <span class="s1">&#39;OrderBook&#39;</span><span class="p">,</span> <span class="s1">&#39;BarData&#39;</span><span class="p">,</span> <span class="s1">&#39;DailyBar&#39;</span><span class="p">,</span> <span class="s1">&#39;CandleStick&#39;</span><span class="p">,</span> <span class="s1">&#39;TickData&#39;</span><span class="p">,</span> <span class="s1">&#39;TransactionData&#39;</span><span class="p">,</span> <span class="s1">&#39;TradeData&#39;</span><span class="p">,</span> <span class="s1">&#39;OrderData&#39;</span><span class="p">,</span>
           <span class="s1">&#39;MarketDataBuffer&#39;</span><span class="p">,</span> <span class="s1">&#39;MarketDataRingBuffer&#39;</span><span class="p">]</span>
<span class="n">__cache__</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># TICKER_SIZE: int = 16</span>
<span class="c1"># ID_SIZE: int = 16</span>
<span class="c1"># BOOK_SIZE: int = 10</span>

<span class="n">Contexts</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="n">typename</span><span class="o">=</span><span class="s1">&#39;Contexts&#39;</span><span class="p">,</span>
    <span class="n">field_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;TICKER_SIZE&#39;</span><span class="p">,</span> <span class="s1">&#39;ID_SIZE&#39;</span><span class="p">,</span> <span class="s1">&#39;BOOK_SIZE&#39;</span><span class="p">],</span>
    <span class="n">defaults</span><span class="o">=</span><span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
<span class="p">)()</span>

<span class="n">DTYPE_MAPPING</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;OrderBook&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s1">&#39;BarData&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
    <span class="s1">&#39;DailyBar&#39;</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span>
    <span class="s1">&#39;TickData&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
    <span class="s1">&#39;TransactionData&#39;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
    <span class="s1">&#39;TradeData&#39;</span><span class="p">:</span> <span class="mi">41</span><span class="p">,</span>
    <span class="s1">&#39;OrderData&#39;</span><span class="p">:</span> <span class="mi">50</span>
<span class="p">}</span>


<div class="viewcode-block" id="TransactionSide">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.TransactionSide">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TransactionSide</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="n">ShortOrder</span> <span class="o">=</span> <span class="n">AskOrder</span> <span class="o">=</span> <span class="n">Offer_to_Short</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span>
    <span class="n">ShortOpen</span> <span class="o">=</span> <span class="n">Sell_to_Short</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
    <span class="n">ShortFilled</span> <span class="o">=</span> <span class="n">LongClose</span> <span class="o">=</span> <span class="n">Sell_to_Unwind</span> <span class="o">=</span> <span class="n">ask</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">UNKNOWN</span> <span class="o">=</span> <span class="n">CANCEL</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">LongFilled</span> <span class="o">=</span> <span class="n">LongOpen</span> <span class="o">=</span> <span class="n">Buy_to_Long</span> <span class="o">=</span> <span class="n">bid</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">ShortClose</span> <span class="o">=</span> <span class="n">Buy_to_Cover</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">LongOrder</span> <span class="o">=</span> <span class="n">BidOrder</span> <span class="o">=</span> <span class="n">Bid_to_Long</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the opposite transaction side.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TransactionSide: The opposite transaction side.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">LongOpen</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">LongClose</span>
        <span class="k">elif</span> <span class="bp">self</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">LongClose</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">LongOpen</span>
        <span class="k">elif</span> <span class="bp">self</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShortOpen</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShortClose</span>
        <span class="k">elif</span> <span class="bp">self</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShortClose</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShortOpen</span>
        <span class="k">elif</span> <span class="bp">self</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">BidOrder</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">AskOrder</span>
        <span class="k">elif</span> <span class="bp">self</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">AskOrder</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">BidOrder</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No valid registered opposite trade side for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN</span>

<div class="viewcode-block" id="TransactionSide.from_offset">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.TransactionSide.from_offset">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_offset</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the transaction side from direction and offset.</span>

<span class="sd">        Args:</span>
<span class="sd">            direction (str): The trade direction (e.g., &#39;buy&#39;, &#39;sell&#39;).</span>
<span class="sd">            offset (str): The trade offset (e.g., &#39;open&#39;, &#39;close&#39;).</span>

<span class="sd">        Returns:</span>
<span class="sd">            TransactionSide: The corresponding transaction side.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the direction or offset is not recognized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;wind&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">LongOpen</span>
            <span class="k">elif</span> <span class="n">offset</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;cover&#39;</span><span class="p">,</span> <span class="s1">&#39;unwind&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ShortOpen</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Not recognized </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;wind&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ShortOpen</span>
            <span class="k">elif</span> <span class="n">offset</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;cover&#39;</span><span class="p">,</span> <span class="s1">&#39;unwind&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">LongClose</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Not recognized </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Not recognized </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_missing_</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle missing values in the enumeration.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (str | int): The value to resolve.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TransactionSide: The resolved transaction side, or UNKNOWN if not recognized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">capital_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">capital_str</span> <span class="o">==</span> <span class="s1">&#39;Long&#39;</span> <span class="ow">or</span> <span class="n">capital_str</span> <span class="o">==</span> <span class="s1">&#39;Buy&#39;</span> <span class="ow">or</span> <span class="n">capital_str</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span>
            <span class="n">trade_side</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">LongOpen</span>
        <span class="k">elif</span> <span class="n">capital_str</span> <span class="o">==</span> <span class="s1">&#39;Short&#39;</span> <span class="ow">or</span> <span class="n">capital_str</span> <span class="o">==</span> <span class="s1">&#39;Ss&#39;</span><span class="p">:</span>
            <span class="n">trade_side</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ShortOpen</span>
        <span class="k">elif</span> <span class="n">capital_str</span> <span class="o">==</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">or</span> <span class="n">capital_str</span> <span class="o">==</span> <span class="s1">&#39;Sell&#39;</span> <span class="ow">or</span> <span class="n">capital_str</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
            <span class="n">trade_side</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">LongClose</span>
        <span class="k">elif</span> <span class="n">capital_str</span> <span class="o">==</span> <span class="s1">&#39;Cover&#39;</span> <span class="ow">or</span> <span class="n">capital_str</span> <span class="o">==</span> <span class="s1">&#39;Bc&#39;</span><span class="p">:</span>
            <span class="n">trade_side</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ShortClose</span>
        <span class="k">elif</span> <span class="n">capital_str</span> <span class="o">==</span> <span class="s1">&#39;Ask&#39;</span><span class="p">:</span>
            <span class="n">trade_side</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AskOrder</span>
        <span class="k">elif</span> <span class="n">capital_str</span> <span class="o">==</span> <span class="s1">&#39;Bid&#39;</span><span class="p">:</span>
            <span class="n">trade_side</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">BidOrder</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># noinspection PyBroadException</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">trade_side</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
                <span class="n">trade_side</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">UNKNOWN</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is not recognized, return TransactionSide.UNKNOWN&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">trade_side</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sign</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the sign of the transaction side.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: 1 for buy/long, -1 for sell/short, 0 for unknown.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Buy_to_Long</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Buy_to_Cover</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sell_to_Unwind</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sell_to_Short</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span>
            <span class="n">caller</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getframeinfo</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_back</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Requesting .sign of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is not recommended, use .order_sign instead. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Called from </span><span class="si">{</span><span class="n">caller</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2">, line </span><span class="si">{</span><span class="n">caller</span><span class="o">.</span><span class="n">lineno</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_sign</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">order_sign</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the order sign of the transaction side.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: 1 for long orders, -1 for short orders, 0 for unknown.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">LongOrder</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShortOrder</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Requesting .order_sign of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> is not recommended, use .sign instead&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">offset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the offset of the transaction side.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The offset value, equivalent to the sign.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">side_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the name of the transaction side.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: &#39;Long&#39;, &#39;Short&#39;, &#39;ask&#39;, &#39;bid&#39;, or &#39;Unknown&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Buy_to_Long</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Buy_to_Cover</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Long&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sell_to_Unwind</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sell_to_Short</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Short&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Offer_to_Short</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;ask&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bid_to_Long</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;bid&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Unknown&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">offset_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the offset name of the transaction side.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: &#39;Open&#39;, &#39;Close&#39;, &#39;ask&#39;, &#39;bid&#39;, or &#39;Unknown&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Buy_to_Long</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sell_to_Short</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Open&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Buy_to_Cover</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sell_to_Unwind</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Close&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Offer_to_Short</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bid_to_Long</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Requesting offset of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> is not supported, returns </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">side_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">side_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Unknown&#39;</span></div>



<div class="viewcode-block" id="OrderType">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.OrderType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OrderType</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="n">UNKNOWN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">20</span>
    <span class="n">CancelOrder</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
    <span class="n">Generic</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">LimitOrder</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">LimitMarketMaking</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="n">MarketOrder</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">FOK</span> <span class="o">=</span> <span class="mi">21</span>
    <span class="n">FAK</span> <span class="o">=</span> <span class="mi">22</span>
    <span class="n">IOC</span> <span class="o">=</span> <span class="mi">23</span></div>



<div class="viewcode-block" id="MarketData">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketData">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MarketData</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">):</span>
<div class="viewcode-block" id="MarketData.__init__">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketData.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="n">buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span> <span class="o">=</span> <span class="n">encoding</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">DTYPE_MAPPING</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_additional</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new_md</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="n">buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">from_buffer_copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_additional&#39;</span><span class="p">):</span>
            <span class="n">new_md</span><span class="o">.</span><span class="n">_additional</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_additional</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">new_md</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;getitem from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> deprecated!&#39;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;getitem from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> deprecated!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">),)</span>

<div class="viewcode-block" id="MarketData.copy">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketData.copy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__copy__</span><span class="p">()</span></div>


<div class="viewcode-block" id="MarketData.to_json">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketData.to_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="o">**</span><span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">value</span><span class="p">[:]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span> <span class="o">:=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">Array</span><span class="p">)</span> <span class="k">else</span> <span class="n">value</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_additional&#39;</span><span class="p">):</span>
            <span class="n">data_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_additional</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;dict&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data_dict</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;str&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid format </span><span class="si">{</span><span class="n">fmt</span><span class="si">}</span><span class="s1">, expected &quot;dict&quot; or &quot;str&quot;.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MarketData.from_json">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketData.from_json">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">json_message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span> <span class="o">|</span> <span class="nb">bytearray</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_message</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">json_dict</span> <span class="o">=</span> <span class="n">json_message</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">json_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_message</span><span class="p">)</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="n">json_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;BarData&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BarData</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">json_dict</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;DailyBar&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DailyBar</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">json_dict</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;TickData&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TickData</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">json_dict</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;TransactionData&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TransactionData</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">json_dict</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;TradeData&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TradeData</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">json_dict</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;OrderBook&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">OrderBook</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">json_dict</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;OrderData&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">OrderData</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">json_dict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid dtype </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MarketData.parse_buffer">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketData.parse_buffer">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse_buffer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">Union</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">:</span>
        <span class="n">dtype_int</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">dtype</span>

        <span class="k">if</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">buffer</span><span class="o">.</span><span class="n">OrderBook</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">20</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">buffer</span><span class="o">.</span><span class="n">BarData</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">21</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">buffer</span><span class="o">.</span><span class="n">BarData</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">30</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">buffer</span><span class="o">.</span><span class="n">TickData</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">buffer</span><span class="o">.</span><span class="n">TransactionData</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">41</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">buffer</span><span class="o">.</span><span class="n">TransactionData</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">50</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">buffer</span><span class="o">.</span><span class="n">OrderData</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid buffer type </span><span class="si">{</span><span class="n">dtype_int</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MarketData.cast_buffer">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketData.cast_buffer">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cast_buffer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span> <span class="o">|</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">Union</span> <span class="o">|</span> <span class="nb">memoryview</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
        <span class="n">dtype_int</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">dtype</span>

        <span class="k">if</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">_BUFFER_CONSTRUCTOR</span><span class="o">.</span><span class="n">new_orderbook_buffer</span><span class="p">()</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">OrderBook</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">_BUFFER_CONSTRUCTOR</span><span class="o">.</span><span class="n">new_candlestick_buffer</span><span class="p">()</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">BarData</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">21</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">_BUFFER_CONSTRUCTOR</span><span class="o">.</span><span class="n">new_candlestick_buffer</span><span class="p">()</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">DailyBar</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">30</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">_BUFFER_CONSTRUCTOR</span><span class="o">.</span><span class="n">new_tick_buffer</span><span class="p">()</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">TickData</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">_BUFFER_CONSTRUCTOR</span><span class="o">.</span><span class="n">new_transaction_buffer</span><span class="p">()</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">TransactionData</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">41</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">_BUFFER_CONSTRUCTOR</span><span class="o">.</span><span class="n">new_transaction_buffer</span><span class="p">()</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">TradeData</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">_BUFFER_CONSTRUCTOR</span><span class="o">.</span><span class="n">new_order_buffer</span><span class="p">()</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">OrderData</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid buffer type </span><span class="si">{</span><span class="n">dtype_int</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MarketData.from_buffer">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketData.from_buffer">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_buffer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
        <span class="n">dtype_int</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">dtype</span>

        <span class="k">if</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">OrderBook</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">20</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BarData</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">21</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DailyBar</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">30</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TickData</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TransactionData</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">41</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TradeData</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">50</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">OrderData</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid buffer type </span><span class="si">{</span><span class="n">dtype_int</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MarketData.from_bytes">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketData.from_bytes">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_bytes</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
        <span class="n">dtype_int</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">_BUFFER_CONSTRUCTOR</span><span class="o">.</span><span class="n">new_orderbook_buffer</span><span class="p">()</span><span class="o">.</span><span class="n">from_buffer_copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">OrderBook</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">_BUFFER_CONSTRUCTOR</span><span class="o">.</span><span class="n">new_candlestick_buffer</span><span class="p">()</span><span class="o">.</span><span class="n">from_buffer_copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">BarData</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">21</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">_BUFFER_CONSTRUCTOR</span><span class="o">.</span><span class="n">new_candlestick_buffer</span><span class="p">()</span><span class="o">.</span><span class="n">from_buffer_copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">DailyBar</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">30</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">_BUFFER_CONSTRUCTOR</span><span class="o">.</span><span class="n">new_tick_buffer</span><span class="p">()</span><span class="o">.</span><span class="n">from_buffer_copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">TickData</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">_BUFFER_CONSTRUCTOR</span><span class="o">.</span><span class="n">new_transaction_buffer</span><span class="p">()</span><span class="o">.</span><span class="n">from_buffer_copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">TransactionData</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">41</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">_BUFFER_CONSTRUCTOR</span><span class="o">.</span><span class="n">new_transaction_buffer</span><span class="p">()</span><span class="o">.</span><span class="n">from_buffer_copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">TradeData</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype_int</span> <span class="o">==</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">_BUFFER_CONSTRUCTOR</span><span class="o">.</span><span class="n">new_order_buffer</span><span class="p">()</span><span class="o">.</span><span class="n">from_buffer_copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">OrderData</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid buffer type </span><span class="si">{</span><span class="n">dtype_int</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ticker</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">ticker_bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">ticker</span>
        <span class="k">return</span> <span class="n">ticker_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">timestamp</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">additional</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_additional&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_additional</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">topic</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">market_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">|</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="n">PROFILE</span><span class="o">.</span><span class="n">time_zone</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">,</span> <span class="s1">&#39;_fields_&#39;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">byte_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">market_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="o">...</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">BufferConstructor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cache&#39;</span><span class="p">,</span> <span class="n">__cache__</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;MarketData&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_md_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;MarketData&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_md_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;MarketData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;OrderBook&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_orderbook_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;OrderBook&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_orderbook_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;OrderBook&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;BarData&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_candlestick_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;BarData&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_candlestick_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;BarData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;TickData&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tick_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;TickData&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tick_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;TickData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;TransactionData&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trade_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;TransactionData&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trade_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;TransactionData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;OrderData&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_order_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;OrderData&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_order_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;OrderData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">]:</span>
        <span class="k">match</span> <span class="n">dtype</span><span class="p">:</span>
            <span class="k">case</span> <span class="s1">&#39;MarketData&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_market_data_buffer</span><span class="p">()</span>
            <span class="k">case</span> <span class="s1">&#39;OrderBook&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_orderbook_buffer</span><span class="p">()</span>
            <span class="k">case</span> <span class="s1">&#39;BarData&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_candlestick_buffer</span><span class="p">()</span>
            <span class="k">case</span> <span class="s1">&#39;TickData&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_tick_buffer</span><span class="p">()</span>
            <span class="k">case</span> <span class="s1">&#39;TradeData&#39;</span> <span class="o">|</span> <span class="s1">&#39;TransactionData&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_transaction_buffer</span><span class="p">()</span>
            <span class="k">case</span> <span class="s1">&#39;OrderData&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_order_buffer</span><span class="p">()</span>
            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid dtype </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">new_id_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span><span class="w"> </span><span class="nc">IntID</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
            <span class="n">id_size</span> <span class="o">=</span> <span class="n">Contexts</span><span class="o">.</span><span class="n">ID_SIZE</span>

            <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;id_type&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_byte</span> <span class="o">*</span> <span class="n">id_size</span><span class="p">),</span>
            <span class="p">]</span>

        <span class="k">class</span><span class="w"> </span><span class="nc">StrID</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
            <span class="n">id_size</span> <span class="o">=</span> <span class="n">Contexts</span><span class="o">.</span><span class="n">ID_SIZE</span>

            <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;id_type&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char</span> <span class="o">*</span> <span class="n">id_size</span><span class="p">),</span>
            <span class="p">]</span>

        <span class="k">class</span><span class="w"> </span><span class="nc">UnionID</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Union</span><span class="p">):</span>
            <span class="n">id_size</span> <span class="o">=</span> <span class="n">Contexts</span><span class="o">.</span><span class="n">ID_SIZE</span>

            <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;id_type&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;id_int&#39;</span><span class="p">,</span> <span class="n">IntID</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;id_str&#39;</span><span class="p">,</span> <span class="n">StrID</span><span class="p">),</span>
            <span class="p">]</span>

        <span class="k">return</span> <span class="n">UnionID</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">new_orderbook_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">]:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">:=</span> <span class="p">(</span><span class="n">Contexts</span><span class="o">.</span><span class="n">TICKER_SIZE</span><span class="p">,</span> <span class="n">Contexts</span><span class="o">.</span><span class="n">BOOK_SIZE</span><span class="p">))</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orderbook_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orderbook_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">class</span><span class="w"> </span><span class="nc">_Buffer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
            <span class="n">ticker_size</span> <span class="o">=</span> <span class="n">Contexts</span><span class="o">.</span><span class="n">TICKER_SIZE</span>
            <span class="n">book_size</span> <span class="o">=</span> <span class="n">Contexts</span><span class="o">.</span><span class="n">BOOK_SIZE</span>

            <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint8</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;ticker&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char</span> <span class="o">*</span> <span class="n">ticker_size</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;bid_price&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">book_size</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;ask_price&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">book_size</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;bid_volume&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">book_size</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;ask_volume&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">book_size</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;bid_n_orders&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint</span> <span class="o">*</span> <span class="n">book_size</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;ask_n_orders&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint</span> <span class="o">*</span> <span class="n">book_size</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_orderbook_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_Buffer</span>
        <span class="k">return</span> <span class="n">_Buffer</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">new_candlestick_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">]:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">:=</span> <span class="n">Contexts</span><span class="o">.</span><span class="n">TICKER_SIZE</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_candlestick_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_candlestick_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">class</span><span class="w"> </span><span class="nc">_Buffer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
            <span class="n">ticker_size</span> <span class="o">=</span> <span class="n">Contexts</span><span class="o">.</span><span class="n">TICKER_SIZE</span>

            <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint8</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;ticker&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char</span> <span class="o">*</span> <span class="n">ticker_size</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;start_timestamp&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;bar_span&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;high_price&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;low_price&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;open_price&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;close_price&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;notional&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;trade_count&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint</span><span class="p">),</span>
            <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_candlestick_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_Buffer</span>
        <span class="k">return</span> <span class="n">_Buffer</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">new_tick_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">]:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">:=</span> <span class="n">Contexts</span><span class="o">.</span><span class="n">TICKER_SIZE</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tick_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tick_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">class</span><span class="w"> </span><span class="nc">_Buffer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
            <span class="n">ticker_size</span> <span class="o">=</span> <span class="n">Contexts</span><span class="o">.</span><span class="n">TICKER_SIZE</span>

            <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint8</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;ticker&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char</span> <span class="o">*</span> <span class="n">ticker_size</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;order_book&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_orderbook_buffer</span><span class="p">()),</span>
                <span class="p">(</span><span class="s1">&#39;bid_price&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;bid_volume&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;ask_price&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;ask_volume&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;last_price&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;total_traded_volume&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;total_traded_notional&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;total_trade_count&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint</span><span class="p">),</span>
            <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tick_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_Buffer</span>
        <span class="k">return</span> <span class="n">_Buffer</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">new_transaction_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">]:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">:=</span> <span class="p">(</span><span class="n">Contexts</span><span class="o">.</span><span class="n">TICKER_SIZE</span><span class="p">,</span> <span class="n">Contexts</span><span class="o">.</span><span class="n">ID_SIZE</span><span class="p">))</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trade_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trade_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">TransactionID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_id_buffer</span><span class="p">()</span>

        <span class="k">class</span><span class="w"> </span><span class="nc">_Buffer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
            <span class="n">ticker_size</span> <span class="o">=</span> <span class="n">Contexts</span><span class="o">.</span><span class="n">TICKER_SIZE</span>
            <span class="n">id_size</span> <span class="o">=</span> <span class="n">Contexts</span><span class="o">.</span><span class="n">ID_SIZE</span>

            <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint8</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;ticker&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char</span> <span class="o">*</span> <span class="n">ticker_size</span><span class="p">),</span>  <span class="c1"># Dynamic size based on TICKER_LEN</span>
                <span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;price&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;side&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;multiplier&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;notional&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">,</span> <span class="n">TransactionID</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;buy_id&quot;</span><span class="p">,</span> <span class="n">TransactionID</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;sell_id&quot;</span><span class="p">,</span> <span class="n">TransactionID</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_trade_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_Buffer</span>
        <span class="k">return</span> <span class="n">_Buffer</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">new_order_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">]:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">:=</span> <span class="p">(</span><span class="n">Contexts</span><span class="o">.</span><span class="n">TICKER_SIZE</span><span class="p">,</span> <span class="n">Contexts</span><span class="o">.</span><span class="n">ID_SIZE</span><span class="p">))</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trade_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">OrderID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_id_buffer</span><span class="p">()</span>

        <span class="k">class</span><span class="w"> </span><span class="nc">_Buffer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
            <span class="n">ticker_size</span> <span class="o">=</span> <span class="n">Contexts</span><span class="o">.</span><span class="n">TICKER_SIZE</span>
            <span class="n">id_size</span> <span class="o">=</span> <span class="n">Contexts</span><span class="o">.</span><span class="n">ID_SIZE</span>

            <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint8</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;ticker&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char</span> <span class="o">*</span> <span class="n">ticker_size</span><span class="p">),</span>  <span class="c1"># Dynamic size based on TICKER_LEN</span>
                <span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;price&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;side&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;order_id&quot;</span><span class="p">,</span> <span class="n">OrderID</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;order_type&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">),</span>
            <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_order_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_Buffer</span>
        <span class="k">return</span> <span class="n">_Buffer</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">new_market_data_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Union</span><span class="p">]:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">:=</span> <span class="n">Contexts</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_md_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_md_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">class</span><span class="w"> </span><span class="nc">_Buffer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Union</span><span class="p">):</span>
            <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint8</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;OrderBook&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_orderbook_buffer</span><span class="p">()),</span>
                <span class="p">(</span><span class="s2">&quot;BarData&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_candlestick_buffer</span><span class="p">()),</span>
                <span class="p">(</span><span class="s2">&quot;TickData&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_tick_buffer</span><span class="p">()),</span>
                <span class="p">(</span><span class="s2">&quot;TransactionData&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_transaction_buffer</span><span class="p">()),</span>
                <span class="p">(</span><span class="s1">&#39;OrderData&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_order_buffer</span><span class="p">())</span>
            <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_md_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_Buffer</span>
        <span class="k">return</span> <span class="n">_Buffer</span>


<span class="n">_BUFFER_CONSTRUCTOR</span> <span class="o">=</span> <span class="n">BufferConstructor</span><span class="p">()</span>


<div class="viewcode-block" id="OrderBook">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.OrderBook">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OrderBook</span><span class="p">(</span><span class="n">MarketData</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing an order book, which tracks bid and ask orders for a financial instrument.</span>

<span class="sd">    Nested Classes:</span>
<span class="sd">        Book: Represents a side of the order book (either bid or ask), with methods for managing entries.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="OrderBook.Book">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.OrderBook.Book">[docs]</a>
    <span class="k">class</span><span class="w"> </span><span class="nc">Book</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class representing a side of the order book (either bid or ask).</span>

<span class="sd">        Attributes:</span>
<span class="sd">            side (int): Indicates the side of the book; positive for bid, negative for ask.</span>
<span class="sd">            _book (list[tuple[float, float, ...]]): A list of tuples representing (price, volume, order).</span>
<span class="sd">            _dict (dict[float, tuple[float, float, ...]]): A dictionary mapping prices to order book entries.</span>
<span class="sd">            sorted (bool): Indicates whether the book is sorted.</span>
<span class="sd">        &quot;&quot;&quot;</span>

<div class="viewcode-block" id="OrderBook.Book.__init__">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.OrderBook.Book.__init__">[docs]</a>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">side</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Initialize the order book for a specific side.</span>

<span class="sd">            Args:</span>
<span class="sd">                side (int): Side of the book; positive for bid, negative for ask.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">side</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">side</span>
            <span class="c1"># store the entry in order of (price, volume, order, etc...)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_book</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span> <span class="o">=</span> <span class="kc">False</span></div>


        <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Iterate over the sorted order book.</span>

<span class="sd">            Returns:</span>
<span class="sd">                iterator: An iterator over the sorted book entries.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_book</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Retrieve an entry by price or level.</span>

<span class="sd">            Args:</span>
<span class="sd">                item (int | float): Level number (int) or price (float).</span>

<span class="sd">            Returns:</span>
<span class="sd">                tuple[float, float, ...]: The order book entry at the specified level or price.</span>

<span class="sd">            Raises:</span>
<span class="sd">                KeyError: If the index value is ambiguous.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_level</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_price</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ambiguous index value </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s1">, please use at_price or at_level specifically&#39;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Check if a price exists in the order book.</span>

<span class="sd">            Args:</span>
<span class="sd">                price (float): The price to check.</span>

<span class="sd">            Returns:</span>
<span class="sd">                bool: True if the price exists, False otherwise.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get the number of entries in the order book.</span>

<span class="sd">            Returns:</span>
<span class="sd">                int: The number of entries.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_book</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get a string representation of the book.</span>

<span class="sd">            Returns:</span>
<span class="sd">                str: A string indicating whether the book is for bids or asks.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;OrderBook.Book.</span><span class="si">{</span><span class="s2">&quot;Bid&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">side</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;Ask&quot;</span><span class="si">}</span><span class="s1">&gt;&#39;</span>

        <span class="k">def</span><span class="w"> </span><span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Check if the order book has any entries.</span>

<span class="sd">            Returns:</span>
<span class="sd">                bool: True if the book is not empty, False otherwise.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_book</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Subtract another order book from this one to find the differences in volumes at matching prices.</span>

<span class="sd">            Args:</span>
<span class="sd">                other (OrderBook.Book): The other book to compare against.</span>

<span class="sd">            Returns:</span>
<span class="sd">                dict[float, float]: A dictionary of price differences.</span>

<span class="sd">            Raises:</span>
<span class="sd">                TypeError: If the other object is not of type OrderBook.Book.</span>
<span class="sd">                ValueError: If the sides of the books do not match.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expect type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">side</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">side</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expect side </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">side</span><span class="si">}</span><span class="s1">, got </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">side</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">diff</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># bid book</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">other</span><span class="o">.</span><span class="n">_dict</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">side</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">limit_0</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="p">)</span>
                <span class="n">limit_1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_dict</span><span class="p">)</span>
                <span class="n">limit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">limit_0</span><span class="p">,</span> <span class="n">limit_1</span><span class="p">)</span>
                <span class="n">contain_limit</span> <span class="o">=</span> <span class="n">limit_0</span> <span class="o">==</span> <span class="n">limit_1</span>

                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_book</span><span class="p">:</span>
                    <span class="n">price</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">entry</span>

                    <span class="k">if</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">limit</span> <span class="ow">or</span> <span class="p">(</span><span class="n">price</span> <span class="o">&gt;=</span> <span class="n">limit</span> <span class="ow">and</span> <span class="n">contain_limit</span><span class="p">):</span>
                        <span class="n">diff</span><span class="p">[</span><span class="n">price</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume</span>

                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">_book</span><span class="p">:</span>
                    <span class="n">price</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">entry</span>

                    <span class="k">if</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">limit</span> <span class="ow">or</span> <span class="p">(</span><span class="n">price</span> <span class="o">&gt;=</span> <span class="n">limit</span> <span class="ow">and</span> <span class="n">contain_limit</span><span class="p">):</span>
                        <span class="n">diff</span><span class="p">[</span><span class="n">price</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">-</span> <span class="n">volume</span>
            <span class="c1"># ask book</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">limit_0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="p">)</span>
                <span class="n">limit_1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_dict</span><span class="p">)</span>
                <span class="n">limit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">limit_0</span><span class="p">,</span> <span class="n">limit_1</span><span class="p">)</span>
                <span class="n">contain_limit</span> <span class="o">=</span> <span class="n">limit_0</span> <span class="o">==</span> <span class="n">limit_1</span>

                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_book</span><span class="p">:</span>
                    <span class="n">price</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">entry</span>

                    <span class="k">if</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="ow">or</span> <span class="p">(</span><span class="n">price</span> <span class="o">&lt;=</span> <span class="n">limit</span> <span class="ow">and</span> <span class="n">contain_limit</span><span class="p">):</span>
                        <span class="n">diff</span><span class="p">[</span><span class="n">price</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume</span>

                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">_book</span><span class="p">:</span>
                    <span class="n">price</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">entry</span>

                    <span class="k">if</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="ow">or</span> <span class="p">(</span><span class="n">price</span> <span class="o">&lt;=</span> <span class="n">limit</span> <span class="ow">and</span> <span class="n">contain_limit</span><span class="p">):</span>
                        <span class="n">diff</span><span class="p">[</span><span class="n">price</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">-</span> <span class="n">volume</span>

            <span class="k">return</span> <span class="n">diff</span>

<div class="viewcode-block" id="OrderBook.Book.get">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.OrderBook.Book.get">[docs]</a>
        <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Retrieve an entry by price or level, with flexibility for keyword arguments.</span>

<span class="sd">            Args:</span>
<span class="sd">                item (int | float, optional): The level (int) or price (float) to retrieve.</span>
<span class="sd">                **kwargs: Additional arguments for price or level.</span>

<span class="sd">            Returns:</span>
<span class="sd">                tuple[float, float, ...] | None: The entry at the specified price or level, or None if not found.</span>

<span class="sd">            Raises:</span>
<span class="sd">                ValueError: If both price and level are not provided or both are provided.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">price</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">price</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">level</span> <span class="o">=</span> <span class="n">item</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                    <span class="n">price</span> <span class="o">=</span> <span class="n">item</span>
                    <span class="n">level</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="si">}</span><span class="s1">, must be int or float&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">price</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must assign either price or level in kwargs&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_level</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_price</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must NOT assign both price and level in kwargs&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="OrderBook.Book.pop">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.OrderBook.Book.pop">[docs]</a>
        <span class="k">def</span><span class="w"> </span><span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Remove and return an entry at the specified price.</span>

<span class="sd">            Args:</span>
<span class="sd">                price (float): The price of the entry to remove.</span>

<span class="sd">            Returns:</span>
<span class="sd">                tuple[float, float, ...]: The removed entry.</span>

<span class="sd">            Raises:</span>
<span class="sd">                KeyError: If the price does not exist in the order book.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">entry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_book</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Price </span><span class="si">{</span><span class="n">price</span><span class="si">}</span><span class="s1"> does not exist in the order book&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">entry</span></div>


<div class="viewcode-block" id="OrderBook.Book.remove">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.OrderBook.Book.remove">[docs]</a>
        <span class="k">def</span><span class="w"> </span><span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Remove a specific entry from the order book.</span>

<span class="sd">            Args:</span>
<span class="sd">                entry (tuple[float, float, ...]): The entry to remove.</span>

<span class="sd">            Raises:</span>
<span class="sd">                ValueError: If the entry does not exist in the order book.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_book</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Entry </span><span class="si">{</span><span class="n">entry</span><span class="si">}</span><span class="s1"> does not exist in the order book&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="OrderBook.Book.at_price">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.OrderBook.Book.at_price">[docs]</a>
        <span class="k">def</span><span class="w"> </span><span class="nf">at_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get the entry at a specific price.</span>

<span class="sd">            Args:</span>
<span class="sd">                price (float): The price to search for.</span>

<span class="sd">            Returns:</span>
<span class="sd">                tuple[float, float, ...]: The entry at the given price, or None if not found.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">price</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="OrderBook.Book.at_level">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.OrderBook.Book.at_level">[docs]</a>
        <span class="k">def</span><span class="w"> </span><span class="nf">at_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get the entry at a specific level.</span>

<span class="sd">            Args:</span>
<span class="sd">                level (int): The level to search for.</span>

<span class="sd">            Returns:</span>
<span class="sd">                tuple[float, float, ...]: The entry at the given level.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_book</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">level</span><span class="p">)</span></div>


<div class="viewcode-block" id="OrderBook.Book.update">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.OrderBook.Book.update">[docs]</a>
        <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Update or add an entry in the order book.</span>

<span class="sd">            Args:</span>
<span class="sd">                price (float): The price of the entry to update.</span>
<span class="sd">                volume (float): The new volume for the entry.</span>
<span class="sd">                order (int, optional): The order number. Defaults to None.</span>

<span class="sd">            Raises:</span>
<span class="sd">                ValueError: If the volume is invalid.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">price</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">volume</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">volume</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid volume </span><span class="si">{</span><span class="n">volume</span><span class="si">}</span><span class="s1">, expect a positive float.&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="p">[</span><span class="n">price</span><span class="p">]</span>
                    <span class="n">new_entry</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
                    <span class="n">new_entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="p">[</span><span class="n">price</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_entry</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_book</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_book</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">entry</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_entry</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="n">volume</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span></div>


<div class="viewcode-block" id="OrderBook.Book.add">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.OrderBook.Book.add">[docs]</a>
        <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Add a new entry to the order book.</span>

<span class="sd">            Args:</span>
<span class="sd">                price (float): The price of the new entry.</span>
<span class="sd">                volume (float): The volume of the new entry.</span>
<span class="sd">                order (int, optional): The order number. Defaults to None.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">order</span> <span class="k">if</span> <span class="n">order</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="p">[</span><span class="n">price</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_book</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span></div>


<div class="viewcode-block" id="OrderBook.Book.loc_volume">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.OrderBook.Book.loc_volume">[docs]</a>
        <span class="k">def</span><span class="w"> </span><span class="nf">loc_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">p1</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculate the total volume between two price levels. Inclusive of the 2 given price.</span>

<span class="sd">            Args:</span>
<span class="sd">                p0 (float): The first price level.</span>
<span class="sd">                p1 (float): The second price level.</span>

<span class="sd">            Returns:</span>
<span class="sd">                float: The total volume between the two prices.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">p_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span>
            <span class="n">p_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_book</span><span class="p">:</span>
                <span class="n">price</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">entry</span>
                <span class="k">if</span> <span class="n">p_min</span> <span class="o">&lt;=</span> <span class="n">price</span> <span class="o">&lt;=</span> <span class="n">p_max</span><span class="p">:</span>
                    <span class="n">volume</span> <span class="o">+=</span> <span class="n">vol</span>

            <span class="k">return</span> <span class="n">volume</span></div>


<div class="viewcode-block" id="OrderBook.Book.sort">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.OrderBook.Book.sort">[docs]</a>
        <span class="k">def</span><span class="w"> </span><span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Sort the order book by price in the appropriate order (descending for bids, ascending for asks).</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">side</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># bid</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_book</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># ask</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_book</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span> <span class="o">=</span> <span class="kc">True</span></div>


        <span class="nd">@property</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get a sorted list of all prices in the order book.</span>

<span class="sd">            Returns:</span>
<span class="sd">                list[float]: A list of all prices.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

            <span class="k">return</span> <span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_book</span><span class="p">]</span>

        <span class="nd">@property</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">volume</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get a sorted list of all volumes in the order book.</span>

<span class="sd">            Returns:</span>
<span class="sd">                list[float]: A list of all volumes.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

            <span class="k">return</span> <span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_book</span><span class="p">]</span></div>


<div class="viewcode-block" id="OrderBook.__init__">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.OrderBook.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">bid</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ask</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize an OrderBook instance with market data.</span>

<span class="sd">        Args:</span>
<span class="sd">            ticker (str): The ticker symbol of the financial instrument.</span>
<span class="sd">            timestamp (float): The timestamp of the market data.</span>
<span class="sd">            bid (list[list[float | int]], optional): A list of bid data, where each sublist contains price, volume, and optionally, order numbers. Defaults to None.</span>
<span class="sd">            ask (list[list[float | int]], optional): A list of ask data. Defaults to None.</span>
<span class="sd">            **kwargs: Additional key-value pairs for parsing extra data fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;buffer&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;buffer&#39;</span><span class="p">])</span>
            <span class="k">return</span>

        <span class="n">buffer_constructor</span> <span class="o">=</span> <span class="n">_BUFFER_CONSTRUCTOR</span><span class="o">.</span><span class="n">new_orderbook_buffer</span><span class="p">()</span>
        <span class="n">book_size</span> <span class="o">=</span> <span class="n">buffer_constructor</span><span class="o">.</span><span class="n">book_size</span>

        <span class="n">bid_price</span><span class="p">,</span> <span class="n">bid_volume</span><span class="p">,</span> <span class="o">*</span><span class="n">bid_n_orders</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">bid</span><span class="p">)</span>
        <span class="n">ask_price</span><span class="p">,</span> <span class="n">ask_volume</span><span class="p">,</span> <span class="o">*</span><span class="n">ask_n_orders</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">ask</span><span class="p">)</span>

        <span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer_constructor</span><span class="p">(</span>
            <span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span>
        <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bid_price</span><span class="p">:</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">bid_price</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">book_size</span><span class="p">)(</span><span class="o">*</span><span class="n">bid_price</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bid_volume</span><span class="p">:</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">bid_volume</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">book_size</span><span class="p">)(</span><span class="o">*</span><span class="n">bid_volume</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bid_n_orders</span><span class="p">:</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">bid_n_orders</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint</span> <span class="o">*</span> <span class="n">book_size</span><span class="p">)(</span><span class="o">*</span><span class="n">bid_n_orders</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ask_price</span><span class="p">:</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">ask_price</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">book_size</span><span class="p">)(</span><span class="o">*</span><span class="n">ask_price</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ask_volume</span><span class="p">:</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">ask_volume</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">book_size</span><span class="p">)(</span><span class="o">*</span><span class="n">ask_volume</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ask_n_orders</span><span class="p">:</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">ask_n_orders</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint</span> <span class="o">*</span> <span class="n">book_size</span><span class="p">)(</span><span class="o">*</span><span class="n">ask_n_orders</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dynamically retrieve attributes like bid_price_X or ask_volume_Y.</span>

<span class="sd">        Args:</span>
<span class="sd">            item (str): The name of the attribute to retrieve.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The value of the requested attribute.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AttributeError: If the attribute is not found or the query level exceeds the maximum level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^((bid_)|(ask_))((price_)|(volume_))[0-9]+$&#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
            <span class="n">side</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">level</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
            <span class="n">book</span><span class="p">:</span> <span class="n">OrderBook</span><span class="o">.</span><span class="n">Book</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">side</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">book</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">book</span><span class="p">[</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;query level [</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s1">] exceed max level [</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">book</span><span class="p">)</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s1"> not found in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dynamically set attributes like bid_price_X or ask_volume_Y.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (str): The name of the attribute to set.</span>
<span class="sd">            value: The value to set for the attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^((bid_)|(ask_))((price_)|(volume_))[0-9]+$&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        String representation of the OrderBook instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A string describing the OrderBook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;OrderBook&gt;([</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">market_time</span><span class="si">:</span><span class="s1">%Y-%m-%d %H:%M:%S</span><span class="si">}</span><span class="s1">] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s1">, bid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_bid_price</span><span class="si">}</span><span class="s1">, ask=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_ask_price</span><span class="si">}</span><span class="s1">)&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        String representation for print output.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A detailed string representation of the OrderBook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;OrderBook&gt;([</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">market_time</span><span class="si">:</span><span class="s1">%Y-%m-%d %H:%M:%S</span><span class="si">}</span><span class="s1">] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s1"> </span><span class="se">{{</span><span class="s1">Bid: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_bid_price</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">best_bid_volume</span><span class="si">}</span><span class="s1">, Ask: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_ask_price</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">best_ask_volume</span><span class="si">}</span><span class="s1">, Level: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_level</span><span class="si">}</span><span class="se">}}</span><span class="s1">)&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Boolean value of the OrderBook instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if both bid and ask sides have entries, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bid</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_entry_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">validate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse an entry name like bid_price_X into its components.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): The entry name to parse.</span>
<span class="sd">            validate (bool, optional): Whether to validate the entry name. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[str, str, int]: The parsed side, key, and level.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If validation fails and the name is not parsable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^((bid_)|(ask_))((price_)|(volume_)|(order_))[0-9]+$&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot parse kwargs </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

        <span class="n">side</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">level</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">side</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">level</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">bid_price_1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">bid_volume_1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">ask_price_1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">ask_volume_1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="o">...</span>

<div class="viewcode-block" id="OrderBook.parse">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.OrderBook.parse">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">validate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse bid and ask data into the OrderBook.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (dict[str, float], optional): A dictionary of data entries to parse. Defaults to None.</span>
<span class="sd">            validate (bool, optional): Whether to validate the entry names. Defaults to False.</span>
<span class="sd">            **kwargs: Additional key-value pairs for parsing into the OrderBook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">side</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_entry_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">side</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)[</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="OrderBook.from_json">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.OrderBook.from_json">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">json_message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span> <span class="o">|</span> <span class="nb">bytearray</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an OrderBook instance from a JSON message.</span>

<span class="sd">        Args:</span>
<span class="sd">            json_message (str | bytes | bytearray | dict): The JSON message to parse.</span>

<span class="sd">        Returns:</span>
<span class="sd">            OrderBook: An instance of the OrderBook class.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the dtype in the JSON message does not match the class name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_message</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">json_dict</span> <span class="o">=</span> <span class="n">json_message</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">json_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_message</span><span class="p">)</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="n">json_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dtype mismatch, expect </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">, got </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

        <span class="n">bid_price</span> <span class="o">=</span> <span class="n">json_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;bid_price&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">bid_volume</span> <span class="o">=</span> <span class="n">json_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;bid_volume&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">bid_n_orders</span> <span class="o">=</span> <span class="n">json_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;bid_n_orders&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">ask_price</span> <span class="o">=</span> <span class="n">json_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ask_price&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">ask_volume</span> <span class="o">=</span> <span class="n">json_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ask_volume&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">ask_n_orders</span> <span class="o">=</span> <span class="n">json_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ask_n_orders&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">json_dict</span><span class="p">)</span>
        <span class="n">book_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">book_size</span>

        <span class="k">if</span> <span class="n">bid_price</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">bid_price</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">book_size</span><span class="p">)(</span><span class="o">*</span><span class="n">bid_price</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bid_volume</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">bid_volume</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">book_size</span><span class="p">)(</span><span class="o">*</span><span class="n">bid_volume</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bid_n_orders</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">bid_n_orders</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint</span> <span class="o">*</span> <span class="n">book_size</span><span class="p">)(</span><span class="o">*</span><span class="n">bid_n_orders</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ask_price</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">ask_price</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">book_size</span><span class="p">)(</span><span class="o">*</span><span class="n">ask_price</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ask_volume</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">ask_volume</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">book_size</span><span class="p">)(</span><span class="o">*</span><span class="n">ask_volume</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ask_n_orders</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">ask_n_orders</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint</span> <span class="o">*</span> <span class="n">book_size</span><span class="p">)(</span><span class="o">*</span><span class="n">ask_n_orders</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="OrderBook.from_buffer">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.OrderBook.from_buffer">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_buffer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">market_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the mid price of the order book.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The mid price, or NaN if not available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid_price</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mid_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the mid price of the order book.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The mid price, or NaN if not available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_bid_price</span><span class="p">)</span> <span class="ow">and</span> <span class="n">math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_ask_price</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_bid_price</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_ask_price</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">spread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the bid-ask spread.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The spread, or NaN if not available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_bid_price</span><span class="p">)</span> <span class="ow">and</span> <span class="n">math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_ask_price</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_ask_price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_bid_price</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">spread_pct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the bid-ask spread as a percentage of the mid price.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The spread percentage, or infinity if mid price is zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid_price</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spread</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid_price</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Book</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the bid side of the order book.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Book: An instance of the Book class representing the bid side.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">book</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Book</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">price</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">n_orders</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">bid_price</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">bid_volume</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">bid_n_orders</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">volume</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">book</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="n">volume</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">n_orders</span><span class="p">)</span>
        <span class="n">book</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">book</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ask</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Book</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the ask side of the order book.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Book: An instance of the Book class representing the ask side.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">book</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Book</span><span class="p">(</span><span class="n">side</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">price</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">n_orders</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">ask_price</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">ask_volume</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">ask_n_orders</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">volume</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">book</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="n">volume</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">n_orders</span><span class="p">)</span>
        <span class="n">book</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">book</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">best_bid_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the best bid price in the order book.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The best bid price, or NaN if not available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">book</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bid</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">book</span><span class="o">.</span><span class="n">at_level</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">best_ask_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the best ask price in the order book.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The best ask price, or NaN if not available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">book</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">book</span><span class="o">.</span><span class="n">at_level</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">best_bid_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the best bid volume in the order book.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The best bid volume, or NaN if not available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">book</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bid</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">book</span><span class="o">.</span><span class="n">at_level</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">best_ask_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the best ask volume in the order book.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The best ask volume, or NaN if not available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">book</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">book</span><span class="o">.</span><span class="n">at_level</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span></div>



<div class="viewcode-block" id="BarData">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.BarData">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BarData</span><span class="p">(</span><span class="n">MarketData</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a single bar of market data for a specific ticker within a given time frame.</span>

<span class="sd">    This class extends the `MarketData` class and includes attributes and methods relevant to a market bar,</span>
<span class="sd">    such as price, volume, and duration. It also provides functionality for data serialization and validation.</span>

<span class="sd">    Methods:</span>
<span class="sd">        from_json(json_message: str | bytes | bytearray | dict) -&gt; BarData:</span>
<span class="sd">            Creates a `BarData` instance from a JSON-encoded message or dictionary.</span>

<span class="sd">        to_list() -&gt; list[float | int | str | bool]:</span>
<span class="sd">            Converts the `BarData` instance to a list of its attributes.</span>

<span class="sd">        from_list(data_list: list[float | int | str | bool]) -&gt; BarData:</span>
<span class="sd">            Creates a `BarData` instance from a list of attributes.</span>

<span class="sd">        is_valid(verbose=False) -&gt; bool:</span>
<span class="sd">            Validates the `BarData` instance to ensure all required fields are set correctly.</span>

<span class="sd">    Properties:</span>
<span class="sd">        high_price (float): The highest price during the bar.</span>
<span class="sd">        low_price (float): The lowest price during the bar.</span>
<span class="sd">        open_price (float): The opening price of the bar.</span>
<span class="sd">        close_price (float): The closing price of the bar.</span>
<span class="sd">        bar_span (datetime.timedelta): The duration of the bar.</span>
<span class="sd">        volume (float): The total volume of trades during the bar.</span>
<span class="sd">        notional (float): The total notional value of trades during the bar.</span>
<span class="sd">        trade_count (int): The number of trades that occurred during the bar.</span>
<span class="sd">        bar_start_time (datetime.datetime): The start time of the bar.</span>
<span class="sd">        vwap (float): The volume-weighted average price for the bar.</span>
<span class="sd">        market_price (float): The closing price of the bar.</span>
<span class="sd">        bar_type (Literal[&#39;Hourly-Plus&#39;, &#39;Hourly&#39;, &#39;Minute-Plus&#39;, &#39;Minute&#39;, &#39;Sub-Minute&#39;]): The type of the bar based on its span.</span>
<span class="sd">        bar_end_time (datetime.datetime | datetime.date): The end time of the bar.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="BarData.__init__">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.BarData.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
            <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>  <span class="c1"># The bar end timestamp</span>
            <span class="n">start_timestamp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">bar_span</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">high_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="n">low_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="n">open_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="n">close_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span>
            <span class="n">notional</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span>
            <span class="n">trade_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a new instance of `BarData`.</span>

<span class="sd">        Args:</span>
<span class="sd">            ticker (str): The ticker symbol for the market data.</span>
<span class="sd">            timestamp (float): The timestamp marking the end of the bar.</span>
<span class="sd">            start_timestamp (float, optional): The timestamp marking the start of the bar. Required if `bar_span` is not provided.</span>
<span class="sd">            bar_span (datetime.timedelta | int | float, optional): The duration of the bar. Either this or `start_timestamp` must be provided.</span>
<span class="sd">            high_price (float, optional): The highest price during the bar. Defaults to NaN.</span>
<span class="sd">            low_price (float, optional): The lowest price during the bar. Defaults to NaN.</span>
<span class="sd">            open_price (float, optional): The opening price of the bar. Defaults to NaN.</span>
<span class="sd">            close_price (float, optional): The closing price of the bar. Defaults to NaN.</span>
<span class="sd">            volume (float, optional): The total volume of trades during the bar. Defaults to 0.0.</span>
<span class="sd">            notional (float, optional): The total notional value of trades during the bar. Defaults to 0.0.</span>
<span class="sd">            trade_count (int, optional): The number of trades that occurred during the bar. Defaults to 0.</span>
<span class="sd">            **kwargs: Additional keyword arguments passed to the parent `MarketData` class.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If neither `start_timestamp` nor `bar_span` is provided or if `bar_span` is of invalid type.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;buffer&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;buffer&#39;</span><span class="p">])</span>
            <span class="k">return</span>

        <span class="n">buffer_constructor</span> <span class="o">=</span> <span class="n">_BUFFER_CONSTRUCTOR</span><span class="o">.</span><span class="n">new_candlestick_buffer</span><span class="p">()</span>

        <span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer_constructor</span><span class="p">(</span>
            <span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
            <span class="n">high_price</span><span class="o">=</span><span class="n">high_price</span><span class="p">,</span>
            <span class="n">low_price</span><span class="o">=</span><span class="n">low_price</span><span class="p">,</span>
            <span class="n">open_price</span><span class="o">=</span><span class="n">open_price</span><span class="p">,</span>
            <span class="n">close_price</span><span class="o">=</span><span class="n">close_price</span><span class="p">,</span>
            <span class="n">volume</span><span class="o">=</span><span class="n">volume</span><span class="p">,</span>
            <span class="n">notional</span><span class="o">=</span><span class="n">notional</span><span class="p">,</span>
            <span class="n">trade_count</span><span class="o">=</span><span class="n">trade_count</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bar_span</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">start_timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must assign either start_timestamp or bar_span or both.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">start_timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># self[&#39;start_timestamp&#39;] = timestamp - bar_span.total_seconds()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bar_span</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">):</span>
                <span class="n">buffer</span><span class="o">.</span><span class="n">bar_span</span> <span class="o">=</span> <span class="n">bar_span</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bar_span</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="n">buffer</span><span class="o">.</span><span class="n">bar_span</span> <span class="o">=</span> <span class="n">bar_span</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid bar_span </span><span class="si">{</span><span class="n">bar_span</span><span class="si">}</span><span class="s1">! Expected a int, float or timedelta!&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">bar_span</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_timestamp</span> <span class="o">=</span> <span class="n">start_timestamp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_timestamp</span> <span class="o">=</span> <span class="n">start_timestamp</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bar_span</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">):</span>
                <span class="n">buffer</span><span class="o">.</span><span class="n">bar_span</span> <span class="o">=</span> <span class="n">bar_span</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bar_span</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="n">buffer</span><span class="o">.</span><span class="n">bar_span</span> <span class="o">=</span> <span class="n">bar_span</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid bar_span </span><span class="si">{</span><span class="n">bar_span</span><span class="si">}</span><span class="s1">! Expected a int, float or timedelta!&#39;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string representation of the `BarData` instance.</span>

<span class="sd">        The string representation includes the class name, market time, ticker symbol, and key price attributes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A string representation of the `BarData` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&gt;([</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">market_time</span><span class="si">:</span><span class="s1">%Y-%m-%d %H:%M:%S</span><span class="si">}</span><span class="s1">] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s1">, open=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">open_price</span><span class="si">}</span><span class="s1">, close=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">close_price</span><span class="si">}</span><span class="s1">, high=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">high_price</span><span class="si">}</span><span class="s1">, low=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">low_price</span><span class="si">}</span><span class="s1">)&#39;</span>

<div class="viewcode-block" id="BarData.from_json">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.BarData.from_json">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">json_message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span> <span class="o">|</span> <span class="nb">bytearray</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a `BarData` instance from a JSON-encoded message or dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            json_message (str | bytes | bytearray | dict): The JSON-encoded message or dictionary containing `BarData` attributes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            BarData: A `BarData` instance initialized with the data from the JSON message.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the dtype in the JSON does not match the class name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_message</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">json_dict</span> <span class="o">=</span> <span class="n">json_message</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">json_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_message</span><span class="p">)</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="n">json_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dtype mismatch, expect </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">, got </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">json_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="BarData.from_buffer">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.BarData.from_buffer">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_buffer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span> <span class="o">|</span> <span class="nb">memoryview</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">high_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The highest price during the bar.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The highest price during the bar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">high_price</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">low_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The lowest price during the bar.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The lowest price during the bar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">low_price</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">open_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The opening price of the bar.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The opening price of the bar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">open_price</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">close_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The closing price of the bar.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The closing price of the bar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">close_price</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bar_span</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The duration of the bar.</span>

<span class="sd">        Returns:</span>
<span class="sd">            datetime.timedelta: The duration of the bar.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">bar_span</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">bar_span</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">bar_span</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">start_timestamp</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">volume</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The total volume of trades during the bar.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The total volume of trades during the bar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">volume</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">notional</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The total notional value of trades during the bar.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The total notional value of trades during the bar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">notional</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">trade_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The number of trades that occurred during the bar.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The number of trades that occurred during the bar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">trade_count</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bar_start_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The start time of the bar.</span>

<span class="sd">        Returns:</span>
<span class="sd">            datetime.datetime: The start time of the bar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">start_timestamp</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">start_timestamp</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">start_timestamp</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="n">PROFILE</span><span class="o">.</span><span class="n">time_zone</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">bar_span</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="n">PROFILE</span><span class="o">.</span><span class="n">time_zone</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">vwap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The volume-weighted average price for the bar.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The VWAP for the bar. Defaults to the closing price if volume is zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">notional</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">market_time</span><span class="si">}</span><span class="s1">] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s1"> Volume data not available, using close_price as default VWAP value&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_price</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates the `BarData` instance to ensure all required fields are set correctly.</span>

<span class="sd">        Args:</span>
<span class="sd">            verbose (bool, optional): If True, logs detailed validation errors. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the `BarData` instance is valid, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s1"> Invalid ticker&#39;</span>
            <span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high_price</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s1"> Invalid high_price&#39;</span>
            <span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">low_price</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s1"> Invalid low_price&#39;</span>
            <span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">open_price</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s1"> Invalid open_price&#39;</span>
            <span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">close_price</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s1"> Invalid close_price&#39;</span>
            <span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s1"> Invalid volume&#39;</span>
            <span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">notional</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s1"> Invalid notional&#39;</span>
            <span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_count</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s1"> Invalid trade_count&#39;</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bar_start_time</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">)),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s1"> Invalid bar_start_time&#39;</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bar_span</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s1"> Invalid bar_span&#39;</span>

            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">market_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The closing price for the `BarData`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The closing price of the bar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_price</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bar_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;Hourly-Plus&#39;</span><span class="p">,</span> <span class="s1">&#39;Hourly&#39;</span><span class="p">,</span> <span class="s1">&#39;Minute-Plus&#39;</span><span class="p">,</span> <span class="s1">&#39;Minute&#39;</span><span class="p">,</span> <span class="s1">&#39;Sub-Minute&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines the type of the bar based on its span.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Literal[&#39;Hourly-Plus&#39;, &#39;Hourly&#39;, &#39;Minute-Plus&#39;, &#39;Minute&#39;, &#39;Sub-Minute&#39;]: The type of the bar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bar_span</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bar_span</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">bar_span</span> <span class="o">&gt;</span> <span class="mi">3600</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Hourly-Plus&#39;</span>
        <span class="k">elif</span> <span class="n">bar_span</span> <span class="o">==</span> <span class="mi">3600</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Hourly&#39;</span>
        <span class="k">elif</span> <span class="n">bar_span</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Minute-Plus&#39;</span>
        <span class="k">elif</span> <span class="n">bar_span</span> <span class="o">==</span> <span class="mi">60</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Minute&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Sub-Minute&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bar_end_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">|</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The end time of the bar.</span>

<span class="sd">        Returns:</span>
<span class="sd">            datetime.datetime | datetime.date: The end time of the bar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_time</span></div>



<div class="viewcode-block" id="DailyBar">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.DailyBar">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DailyBar</span><span class="p">(</span><span class="n">BarData</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a daily bar of market data for a specific ticker.</span>

<span class="sd">    This class extends the `BarData` class and focuses on daily bar data, which includes attributes and methods</span>
<span class="sd">    specific to daily market bars. It supports various ways to define the bar span and manage the market date.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        ...</span>

<span class="sd">    Methods:</span>
<span class="sd">        __repr__() -&gt; str:</span>
<span class="sd">            Returns a string representation of the `DailyBar` instance.</span>

<span class="sd">        to_json(fmt=&#39;str&#39;, **kwargs) -&gt; str | dict:</span>
<span class="sd">            Converts the `DailyBar` instance to a JSON string or dictionary.</span>

<span class="sd">        to_list() -&gt; list[float | int | str | bool]:</span>
<span class="sd">            Converts the `DailyBar` instance to a list of its attributes.</span>

<span class="sd">        from_list(data_list: list[float | int | str | bool]) -&gt; DailyBar:</span>
<span class="sd">            Creates a `DailyBar` instance from a list of attributes.</span>

<span class="sd">    Properties:</span>
<span class="sd">        ticker (str): The ticker symbol for the market data.</span>
<span class="sd">        timestamp (float): The timestamp marking the end of the bar.</span>
<span class="sd">        start_date (datetime.date, optional): The start date of the bar period. Required if `bar_span` is not provided.</span>
<span class="sd">        bar_span (datetime.timedelta | int, optional): The duration of the bar in days. Either this or `start_date` must be provided.</span>
<span class="sd">        high_price (float): The highest price during the bar.</span>
<span class="sd">        low_price (float): The lowest price during the bar.</span>
<span class="sd">        open_price (float): The opening price of the bar.</span>
<span class="sd">        close_price (float): The closing price of the bar.</span>
<span class="sd">        volume (float): The total volume of trades during the bar.</span>
<span class="sd">        notional (float): The total notional value of trades during the bar.</span>
<span class="sd">        trade_count (int): The number of trades that occurred during the bar.</span>
<span class="sd">        bar_span (datetime.timedelta): The duration of the bar in days.</span>

<span class="sd">        market_date (datetime.date): The market date of the bar.</span>
<span class="sd">        market_time (datetime.date): The market date of the bar (same as `market_date`).</span>
<span class="sd">        bar_start_time (datetime.date): The start date of the bar period.</span>
<span class="sd">        bar_end_time (datetime.date): The end date of the bar period.</span>
<span class="sd">        bar_type (Literal[&#39;Daily&#39;, &#39;Daily-Plus&#39;]): The type of the bar based on its span.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DailyBar.__init__">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.DailyBar.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
            <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">market_date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># The market date of the bar, if with 1D data, or the END date of the bar.</span>
            <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">bar_span</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Expect to be a timedelta for several days, or the number of days</span>
            <span class="n">high_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="n">low_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="n">open_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="n">close_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span>
            <span class="n">notional</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span>
            <span class="n">trade_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a new instance of `DailyBar`.</span>

<span class="sd">        Args:</span>
<span class="sd">            ticker (str): The ticker symbol for the market data.</span>
<span class="sd">            market_date (datetime.date | str): The market date of the bar or the end date of the bar.</span>
<span class="sd">            timestamp (float, optional): repurposed to marking the end of the bar. Defaults to None.</span>
<span class="sd">            start_date (datetime.date, optional): The start date of the bar period. Required if `bar_span` is not provided.</span>
<span class="sd">            bar_span (datetime.timedelta | int, optional): The duration of the bar in days. Either this or `start_date` must be provided.</span>
<span class="sd">            high_price (float, optional): The highest price during the bar. Defaults to NaN.</span>
<span class="sd">            low_price (float, optional): The lowest price during the bar. Defaults to NaN.</span>
<span class="sd">            open_price (float, optional): The opening price of the bar. Defaults to NaN.</span>
<span class="sd">            close_price (float, optional): The closing price of the bar. Defaults to NaN.</span>
<span class="sd">            volume (float, optional): The total volume of trades during the bar. Defaults to 0.0.</span>
<span class="sd">            notional (float, optional): The total notional value of trades during the bar. Defaults to 0.0.</span>
<span class="sd">            trade_count (int, optional): The number of trades that occurred during the bar. Defaults to 0.</span>
<span class="sd">            **kwargs: Additional keyword arguments passed to the parent `BarData` class.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If neither `start_date` nor `bar_span` is provided or if `bar_span` is of invalid type.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;buffer&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;buffer&#39;</span><span class="p">])</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">market_date</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">market_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">market_date</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bar_span</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">start_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must assign either datetime.date or bar_span or both.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">start_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bar_span</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">):</span>
                <span class="n">bar_span</span> <span class="o">=</span> <span class="n">bar_span</span><span class="o">.</span><span class="n">days</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bar_span</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid bar_span, expect int, float or timedelta, got </span><span class="si">{</span><span class="n">bar_span</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">bar_span</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bar_span</span> <span class="o">=</span> <span class="p">(</span><span class="n">market_date</span> <span class="o">-</span> <span class="n">start_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">market_date</span> <span class="o">-</span> <span class="n">start_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">==</span> <span class="n">bar_span</span><span class="o">.</span><span class="n">days</span>

        <span class="k">if</span> <span class="n">timestamp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Timestamp of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> should not be provided.&#39;</span><span class="p">)</span>

        <span class="n">timestamp</span> <span class="o">=</span> <span class="mi">10000</span> <span class="o">*</span> <span class="n">market_date</span><span class="o">.</span><span class="n">year</span> <span class="o">+</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">market_date</span><span class="o">.</span><span class="n">month</span> <span class="o">+</span> <span class="n">market_date</span><span class="o">.</span><span class="n">day</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
            <span class="n">bar_span</span><span class="o">=</span><span class="n">bar_span</span><span class="p">,</span>
            <span class="n">high_price</span><span class="o">=</span><span class="n">high_price</span><span class="p">,</span>
            <span class="n">low_price</span><span class="o">=</span><span class="n">low_price</span><span class="p">,</span>
            <span class="n">open_price</span><span class="o">=</span><span class="n">open_price</span><span class="p">,</span>
            <span class="n">close_price</span><span class="o">=</span><span class="n">close_price</span><span class="p">,</span>
            <span class="n">volume</span><span class="o">=</span><span class="n">volume</span><span class="p">,</span>
            <span class="n">notional</span><span class="o">=</span><span class="n">notional</span><span class="p">,</span>
            <span class="n">trade_count</span><span class="o">=</span><span class="n">trade_count</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="DailyBar.__repr__">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.DailyBar.__repr__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string representation of the `DailyBar` instance.</span>

<span class="sd">        The string representation includes the class name, market date, ticker symbol, and key price attributes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A string representation of the `DailyBar` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&gt;([</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">market_time</span><span class="si">:</span><span class="s1">%Y-%m-%d</span><span class="si">}</span><span class="s1">] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s1">, open=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">open_price</span><span class="si">}</span><span class="s1">, close=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">close_price</span><span class="si">}</span><span class="s1">, high=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">high_price</span><span class="si">}</span><span class="s1">, low=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">low_price</span><span class="si">}</span><span class="s1">)&#39;</span></div>


<div class="viewcode-block" id="DailyBar.to_json">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.DailyBar.to_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts the `DailyBar` instance to a JSON string or dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            fmt (str, optional): The format for the JSON output. Either &#39;dict&#39; or &#39;str&#39;. Defaults to &#39;str&#39;.</span>
<span class="sd">            **kwargs: Additional keyword arguments passed to `json.dumps()` if `fmt=&#39;str&#39;`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str | dict: The JSON-encoded representation of the `DailyBar` instance, in the specified format.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If an invalid format is specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;dict&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;market_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;dict&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data_dict</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;str&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid format </span><span class="si">{</span><span class="n">fmt</span><span class="si">}</span><span class="s1">, expected &quot;dict&quot; or &quot;str&quot;.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DailyBar.from_list">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.DailyBar.from_list">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bool</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a `DailyBar` instance from a list of attributes.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_list (list[float | int | str | bool]): A list of attributes representing a `DailyBar` instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DailyBar: A `DailyBar` instance initialized with the data from the list.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the dtype in the list does not match the class name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">market_date</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">high_price</span><span class="p">,</span> <span class="n">low_price</span><span class="p">,</span> <span class="n">open_price</span><span class="p">,</span> <span class="n">close_price</span><span class="p">,</span>
         <span class="n">bar_span</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">notional</span><span class="p">,</span> <span class="n">trade_count</span><span class="p">)</span> <span class="o">=</span> <span class="n">data_list</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dtype mismatch, expect </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">, got </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span>
            <span class="n">market_date</span><span class="o">=</span><span class="n">market_date</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
            <span class="n">high_price</span><span class="o">=</span><span class="n">high_price</span><span class="p">,</span>
            <span class="n">low_price</span><span class="o">=</span><span class="n">low_price</span><span class="p">,</span>
            <span class="n">open_price</span><span class="o">=</span><span class="n">open_price</span><span class="p">,</span>
            <span class="n">close_price</span><span class="o">=</span><span class="n">close_price</span><span class="p">,</span>
            <span class="n">bar_span</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">bar_span</span><span class="p">)</span> <span class="k">if</span> <span class="n">bar_span</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">volume</span><span class="o">=</span><span class="n">volume</span><span class="p">,</span>
            <span class="n">notional</span><span class="o">=</span><span class="n">notional</span><span class="p">,</span>
            <span class="n">trade_count</span><span class="o">=</span><span class="n">trade_count</span>
        <span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bar_span</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The duration of the bar in days.</span>

<span class="sd">        Returns:</span>
<span class="sd">            datetime.timedelta: The duration of the bar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">bar_span</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">market_date</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The market date of the bar.</span>

<span class="sd">        Returns:</span>
<span class="sd">            datetime.date: The market date of the bar.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">int_date</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">_m</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">int_date</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">_m</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">market_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The market date of the bar (same as `market_date`).</span>

<span class="sd">        Returns:</span>
<span class="sd">            datetime.date: The market date of the bar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_date</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bar_start_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The start date of the bar period.</span>

<span class="sd">        Returns:</span>
<span class="sd">            datetime.date: The start date of the bar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_date</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bar_span</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bar_end_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The end date of the bar period.</span>

<span class="sd">        Returns:</span>
<span class="sd">            datetime.date: The end date of the bar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_date</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bar_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;Daily&#39;</span><span class="p">,</span> <span class="s1">&#39;Daily-Plus&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines the type of the bar based on its span.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Literal[&#39;Daily&#39;, &#39;Daily-Plus&#39;]: The type of the bar.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If `bar_span` is not valid for a daily bar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">bar_span</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Daily&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">bar_span</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Daily-Plus&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid bar_span for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">! Expect an int greater or equal to 1, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">bar_span</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="TickData">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.TickData">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TickData</span><span class="p">(</span><span class="n">MarketData</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents tick data for a specific ticker.</span>

<span class="sd">    This class extends the `MarketData` class and focuses on tick-level market data, including last price, bid/ask prices,</span>
<span class="sd">    bid/ask volumes, and order book details.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        ...</span>

<span class="sd">    Methods:</span>
<span class="sd">        __repr__() -&gt; str:</span>
<span class="sd">            Returns a string representation of the `TickData` instance.</span>

<span class="sd">        from_json(json_message: str | bytes | bytearray | dict) -&gt; TickData:</span>
<span class="sd">            Creates a `TickData` instance from a JSON message.</span>

<span class="sd">        to_list() -&gt; list[float | int | str | bool]:</span>
<span class="sd">            Converts the `TickData` instance to a list of its attributes, excluding order book information.</span>

<span class="sd">        from_list(data_list: list[float | int | str | bool]) -&gt; TickData:</span>
<span class="sd">            Creates a `TickData` instance from a list of attributes.</span>

<span class="sd">    Properties:</span>
<span class="sd">    ticker (str): The ticker symbol for the market data.</span>
<span class="sd">        timestamp (float): The timestamp of the tick data.</span>
<span class="sd">        bid (list[list[float | int]] | None): A list of bid prices and volumes. Optional, used to build the order book.</span>
<span class="sd">        ask (list[list[float | int]] | None): A list of ask prices and volumes. Optional, used to build the order book.</span>
<span class="sd">        level_2 (OrderBook | None): The level 2 order book created from the bid and ask data.</span>
<span class="sd">        order_book (OrderBook | None): Alias for `level_2`.</span>
<span class="sd">        last_price (float): The last traded price.</span>
<span class="sd">        bid_price (float | None): The bid price.</span>
<span class="sd">        ask_price (float | None): The ask price.</span>
<span class="sd">        bid_volume (float | None): The bid volume.</span>
<span class="sd">        ask_volume (float | None): The ask volume.</span>
<span class="sd">        total_traded_volume (float): The total traded volume.</span>
<span class="sd">        total_traded_notional (float): The total traded notional value.</span>
<span class="sd">        total_trade_count (float): The total number of trades.</span>
<span class="sd">        mid_price (float): The midpoint price calculated as the average of bid and ask prices.</span>
<span class="sd">        market_price (float): The last traded price.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TickData.__init__">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.TickData.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
            <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">last_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">bid_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">bid_volume</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">ask_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">ask_volume</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">order_book</span><span class="p">:</span> <span class="n">OrderBook</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">bid</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">ask</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">total_traded_volume</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span>
            <span class="n">total_traded_notional</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span>
            <span class="n">total_trade_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a new instance of `TickData`.</span>

<span class="sd">        Args:</span>
<span class="sd">            ticker (str): The ticker symbol for the market data.</span>
<span class="sd">            timestamp (float): The timestamp of the tick data.</span>
<span class="sd">            last_price (float): The last traded price.</span>
<span class="sd">            bid_price (float, optional): The bid price. Defaults to None.</span>
<span class="sd">            bid_volume (float, optional): The bid volume. Defaults to None.</span>
<span class="sd">            ask_price (float, optional): The ask price. Defaults to None.</span>
<span class="sd">            ask_volume (float, optional): The ask volume. Defaults to None.</span>
<span class="sd">            order_book (OrderBook, optional): The order book containing bid and ask data. Defaults to None.</span>
<span class="sd">            bid (Iterable[list[float | int]], optional): A list of bid prices and volumes. Defaults to None.</span>
<span class="sd">            ask (Iterable[list[float | int]], optional): A list of ask prices and volumes. Defaults to None.</span>
<span class="sd">            total_traded_volume (float, optional): The total traded volume. Defaults to 0.0.</span>
<span class="sd">            total_traded_notional (float, optional): The total traded notional value. Defaults to 0.0.</span>
<span class="sd">            total_trade_count (int, optional): The total number of trades. Defaults to 0.</span>
<span class="sd">            **kwargs: Additional keyword arguments passed to the parent `MarketData` class.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;buffer&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;buffer&#39;</span><span class="p">])</span>
            <span class="k">return</span>

        <span class="n">buffer_constructor</span> <span class="o">=</span> <span class="n">_BUFFER_CONSTRUCTOR</span><span class="o">.</span><span class="n">new_tick_buffer</span><span class="p">()</span>

        <span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer_constructor</span><span class="p">(</span>
            <span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
            <span class="n">last_price</span><span class="o">=</span><span class="n">last_price</span><span class="p">,</span>
            <span class="n">bid_price</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">bid_price</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">bid_price</span><span class="p">,</span>
            <span class="n">bid_volume</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">bid_volume</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">bid_volume</span><span class="p">,</span>
            <span class="n">ask_price</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">ask_price</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ask_price</span><span class="p">,</span>
            <span class="n">ask_volume</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">ask_volume</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ask_volume</span><span class="p">,</span>
            <span class="n">total_traded_volume</span><span class="o">=</span><span class="n">total_traded_volume</span><span class="p">,</span>
            <span class="n">total_traded_notional</span><span class="o">=</span><span class="n">total_traded_notional</span><span class="p">,</span>
            <span class="n">total_trade_count</span><span class="o">=</span><span class="n">total_trade_count</span>
        <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">order_book</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_order_book</span> <span class="o">=</span> <span class="n">order_book</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">order_book</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_book</span><span class="o">.</span><span class="n">_buffer</span>
        <span class="k">elif</span> <span class="n">bid</span> <span class="ow">and</span> <span class="n">ask</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_order_book</span> <span class="o">=</span> <span class="n">OrderBook</span><span class="p">(</span><span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">bid</span><span class="o">=</span><span class="n">bid</span><span class="p">,</span> <span class="n">ask</span><span class="o">=</span><span class="n">ask</span><span class="p">)</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">order_book</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_book</span><span class="o">.</span><span class="n">_buffer</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_order_book&#39;</span><span class="p">):</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">bid_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_book</span><span class="o">.</span><span class="n">best_bid_price</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">bid_volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_book</span><span class="o">.</span><span class="n">best_bid_volume</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">ask_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_book</span><span class="o">.</span><span class="n">best_ask_price</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">ask_volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_book</span><span class="o">.</span><span class="n">best_ask_volume</span></div>


<div class="viewcode-block" id="TickData.__repr__">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.TickData.__repr__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string representation of the `TickData` instance.</span>

<span class="sd">        The string representation includes the class name, market time, ticker symbol, and bid/ask prices.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A string representation of the `TickData` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;TickData&gt;([</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">market_time</span><span class="si">:</span><span class="s1">%Y-%m-%d %H:%M:%S</span><span class="si">}</span><span class="s1">] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s1">, bid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bid_price</span><span class="si">}</span><span class="s1">, ask=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ask_price</span><span class="si">}</span><span class="s1">)&#39;</span></div>


<div class="viewcode-block" id="TickData.to_json">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.TickData.to_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;dict&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_order_book&#39;</span><span class="p">):</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;order_book&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_book</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;dict&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;dict&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data_dict</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;str&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid format </span><span class="si">{</span><span class="n">fmt</span><span class="si">}</span><span class="s1">, expected &quot;dict&quot; or &quot;str&quot;.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TickData.from_json">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.TickData.from_json">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">json_message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span> <span class="o">|</span> <span class="nb">bytearray</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a `TickData` instance from a JSON message.</span>

<span class="sd">        Args:</span>
<span class="sd">            json_message (str | bytes | bytearray | dict): The JSON message containing tick data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TickData: A `TickData` instance.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the JSON message does not match the expected data type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_message</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">json_dict</span> <span class="o">=</span> <span class="n">json_message</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">json_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_message</span><span class="p">)</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="n">json_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dtype mismatch, expect </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">, got </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;order_book&#39;</span> <span class="ow">in</span> <span class="n">json_dict</span><span class="p">:</span>
            <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;order_book&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderBook</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">json_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;order_book&#39;</span><span class="p">))</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">json_dict</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="TickData.from_buffer">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.TickData.from_buffer">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_buffer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span> <span class="o">|</span> <span class="nb">memoryview</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">last_price</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">,</span> <span class="s1">&#39;_fields_&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;order_book&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">level_2</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderBook</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The level 2 order book created from the bid and ask data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            OrderBook | None: The `OrderBook` instance if available, otherwise `None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_order_book&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_book</span>
        <span class="k">elif</span> <span class="n">order_book_buffer</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">order_book</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_order_book</span> <span class="o">=</span> <span class="n">OrderBook</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">order_book_buffer</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_book</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">order_book</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderBook</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Alias for `level_2`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            OrderBook | None: The `OrderBook` instance if available, otherwise `None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_2</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">last_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The last traded price.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The last traded price.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">last_price</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bid_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The bid price.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float | None: The bid price if available, otherwise `None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">bid_price</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ask_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The ask price.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float | None: The ask price if available, otherwise `None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">ask_price</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bid_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The bid volume.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float | None: The bid volume if available, otherwise `None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">bid_volume</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ask_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The ask volume.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float | None: The ask volume if available, otherwise `None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">ask_volume</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_traded_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The total traded volume.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The total traded volume.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">total_traded_volume</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_traded_notional</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The total traded notional value.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The total traded notional value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">total_traded_notional</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_trade_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The total number of trades.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The total number of trades.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">total_trade_count</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mid_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The midpoint price calculated as the average of bid and ask prices.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The midpoint price.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bid_price</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask_price</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">market_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The last traded price.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The last traded price.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_price</span></div>



<div class="viewcode-block" id="TransactionData">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.TransactionData">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TransactionData</span><span class="p">(</span><span class="n">MarketData</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents transaction data for a specific market.</span>

<span class="sd">    This class extends the `MarketData` class to handle transaction-level data, including price, volume, side, and identifiers.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        ...</span>

<span class="sd">    Methods:</span>
<span class="sd">        __repr__() -&gt; str:</span>
<span class="sd">            Returns a string representation of the `TransactionData` instance.</span>

<span class="sd">        from_json(json_message: str | bytes | bytearray | dict) -&gt; TransactionData:</span>
<span class="sd">            Creates a `TransactionData` instance from a JSON message.</span>

<span class="sd">        to_list() -&gt; list[float | int | str | bool]:</span>
<span class="sd">            Converts the `TransactionData` instance to a list of its attributes.</span>

<span class="sd">        from_list(data_list: list[float | int | str | bool]) -&gt; TransactionData:</span>
<span class="sd">            Creates a `TransactionData` instance from a list of attributes.</span>

<span class="sd">        merge(trade_data_list: list[TransactionData]) -&gt; TransactionData | None:</span>
<span class="sd">            Merges multiple `TransactionData` instances into a single aggregated `TransactionData` instance.</span>

<span class="sd">    Properties:</span>
<span class="sd">        ticker (str): The ticker symbol for the transaction.</span>
<span class="sd">        timestamp (float): The timestamp of the transaction.</span>

<span class="sd">        price (float): The price at which the transaction occurred.</span>
<span class="sd">        volume (float): The volume of the transaction.</span>
<span class="sd">        side (TransactionSide): The side of the transaction (buy or sell).</span>
<span class="sd">        multiplier (float): The multiplier for the transaction.</span>
<span class="sd">        transaction_id (int | str | None): The identifier for the transaction.</span>
<span class="sd">        buy_id (int | str | None): The identifier for the buying transaction.</span>
<span class="sd">        sell_id (int | str | None): The identifier for the selling transaction.</span>
<span class="sd">        notional (float): The notional value of the transaction.</span>
<span class="sd">        market_price (float): Alias for `price`.</span>
<span class="sd">        flow (float): The flow of the transaction, calculated as side.sign * volume.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TransactionData.__init__">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.TransactionData.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
            <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">side</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">TransactionSide</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">multiplier</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">notional</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">transaction_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">buy_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">sell_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a new instance of `TransactionData`.</span>

<span class="sd">        Args:</span>
<span class="sd">            ticker (str): The ticker symbol for the transaction.</span>
<span class="sd">            price (float): The price at which the transaction occurred.</span>
<span class="sd">            volume (float): The volume of the transaction.</span>
<span class="sd">            timestamp (float): The timestamp of the transaction.</span>
<span class="sd">            side (int | float | str | TransactionSide, optional): The side of the transaction (buy or sell). Defaults to 0.</span>
<span class="sd">            multiplier (float, optional): The multiplier for the transaction. Defaults to None.</span>
<span class="sd">            notional (float, optional): The notional value of the transaction. Defaults to None.</span>
<span class="sd">            transaction_id (str | int, optional): The identifier for the transaction. Defaults to None.</span>
<span class="sd">            buy_id (str | int, optional): The identifier for the buying transaction. Defaults to None.</span>
<span class="sd">            sell_id (str | int, optional): The identifier for the selling transaction. Defaults to None.</span>
<span class="sd">            **kwargs: Additional keyword arguments passed to the parent `MarketData` class.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;buffer&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;buffer&#39;</span><span class="p">])</span>
            <span class="k">return</span>

        <span class="n">buffer_constructor</span> <span class="o">=</span> <span class="n">_BUFFER_CONSTRUCTOR</span><span class="o">.</span><span class="n">new_transaction_buffer</span><span class="p">()</span>
        <span class="n">id_size</span> <span class="o">=</span> <span class="n">buffer_constructor</span><span class="o">.</span><span class="n">id_size</span>

        <span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer_constructor</span><span class="p">(</span>
            <span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
            <span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span>
            <span class="n">volume</span><span class="o">=</span><span class="n">volume</span><span class="p">,</span>
            <span class="n">side</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">side</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">side</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">TransactionSide</span><span class="p">(</span><span class="n">side</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="n">multiplier</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">multiplier</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">multiplier</span><span class="p">,</span>
            <span class="n">notional</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">notional</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">notional</span>
        <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_id</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;transaction_id&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">transaction_id</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">id_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_id</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;buy_id&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">buy_id</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">id_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_id</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;sell_id&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">sell_id</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">id_size</span><span class="p">)</span></div>


<div class="viewcode-block" id="TransactionData.__repr__">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.TransactionData.__repr__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string representation of the `TransactionData` instance.</span>

<span class="sd">        The string representation includes the class name, market time, side, ticker symbol, price, and volume.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A string representation of the `TransactionData` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;TransactionData&gt;([</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">market_time</span><span class="si">:</span><span class="s1">%Y-%m-%d %H:%M:%S</span><span class="si">}</span><span class="s1">] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">side</span><span class="o">.</span><span class="n">side_name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s1">, price=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">price</span><span class="si">}</span><span class="s1">, volume=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="si">}</span><span class="s1">)&#39;</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_set_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;transaction_id&#39;</span><span class="p">,</span> <span class="s1">&#39;buy_id&#39;</span><span class="p">,</span> <span class="s1">&#39;sell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_id&#39;</span><span class="p">],</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">id_str</span><span class="o">.</span><span class="n">id_type</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">id_str</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">id_int</span><span class="o">.</span><span class="n">id_type</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">id_int</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s1">&#39;little&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">id_type</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid id </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">. Expected str or int.&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;transaction_id&#39;</span><span class="p">,</span> <span class="s1">&#39;buy_id&#39;</span><span class="p">,</span> <span class="s1">&#39;sell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_id&#39;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">match</span> <span class="n">buffer</span><span class="o">.</span><span class="n">id_type</span><span class="p">:</span>
            <span class="k">case</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">buffer</span><span class="o">.</span><span class="n">id_str</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">)</span>
            <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">id_int</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s1">&#39;little&#39;</span><span class="p">)</span>
            <span class="k">case</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid id type for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="TransactionData.from_json">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.TransactionData.from_json">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">json_message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span> <span class="o">|</span> <span class="nb">bytearray</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a `TransactionData` instance from a JSON message.</span>

<span class="sd">        Args:</span>
<span class="sd">            json_message (str | bytes | bytearray | dict): The JSON message containing transaction data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TransactionData: A `TransactionData` instance.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the JSON message does not match the expected data type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_message</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">json_dict</span> <span class="o">=</span> <span class="n">json_message</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">json_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_message</span><span class="p">)</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="n">json_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dtype mismatch, expect </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">, got </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">json_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="TransactionData.from_buffer">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.TransactionData.from_buffer">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_buffer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span> <span class="o">|</span> <span class="nb">memoryview</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">price</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">volume</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="TransactionData.merge">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.TransactionData.merge">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">trade_data_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Self</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Self</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merges multiple `TransactionData` instances into a single aggregated `TransactionData` instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            trade_data_list (list[TransactionData]): A list of `TransactionData` instances to merge.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TransactionData | None: A merged `TransactionData` instance if the list is not empty, otherwise `None`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError: If the list contains transaction data for multiple tickers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trade_data_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">ticker</span> <span class="o">=</span> <span class="n">trade_data_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ticker</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">trade</span><span class="o">.</span><span class="n">ticker</span> <span class="o">==</span> <span class="n">ticker</span> <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="n">trade_data_list</span><span class="p">]),</span> <span class="s1">&#39;input contains trade data of multiple ticker&#39;</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">trade</span><span class="o">.</span><span class="n">timestamp</span> <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="n">trade_data_list</span><span class="p">])</span>
        <span class="n">sum_volume</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">trade</span><span class="o">.</span><span class="n">volume</span> <span class="o">*</span> <span class="n">trade</span><span class="o">.</span><span class="n">side</span><span class="o">.</span><span class="n">sign</span> <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="n">trade_data_list</span><span class="p">])</span>
        <span class="n">sum_notional</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">trade</span><span class="o">.</span><span class="n">notional</span> <span class="o">*</span> <span class="n">trade</span><span class="o">.</span><span class="n">side</span><span class="o">.</span><span class="n">sign</span> <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="n">trade_data_list</span><span class="p">])</span>
        <span class="n">trade_side_sign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">sum_volume</span><span class="p">)</span> <span class="k">if</span> <span class="n">sum_volume</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">sum_notional</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">trade_price</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">sum_volume</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">trade_price</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trade_price</span> <span class="o">=</span> <span class="n">sum_notional</span> <span class="o">/</span> <span class="n">sum_volume</span> <span class="k">if</span> <span class="n">sum_volume</span> <span class="k">else</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">sum_notional</span><span class="p">)</span>

        <span class="n">trade_side</span> <span class="o">=</span> <span class="n">TransactionSide</span><span class="p">(</span><span class="n">trade_side_sign</span><span class="p">)</span>
        <span class="n">trade_volume</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">sum_volume</span><span class="p">)</span>
        <span class="n">trade_notional</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">sum_notional</span><span class="p">)</span>

        <span class="n">merged_trade_data</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
            <span class="n">side</span><span class="o">=</span><span class="n">trade_side</span><span class="p">,</span>
            <span class="n">price</span><span class="o">=</span><span class="n">trade_price</span><span class="p">,</span>
            <span class="n">volume</span><span class="o">=</span><span class="n">trade_volume</span><span class="p">,</span>
            <span class="n">notional</span><span class="o">=</span><span class="n">trade_notional</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">merged_trade_data</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The price at which the transaction occurred.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The transaction price.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">price</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">volume</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The volume of the transaction.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The transaction volume.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">volume</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">side</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransactionSide</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The side of the transaction (buy or sell).</span>

<span class="sd">        Returns:</span>
<span class="sd">            TransactionSide: The side of the transaction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TransactionSide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">side</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">multiplier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The multiplier for the transaction. Defaults to 1 if not specified.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The transaction multiplier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">multiplier</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">multiplier</span><span class="p">):</span>
            <span class="n">multiplier</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="k">return</span> <span class="n">multiplier</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">transaction_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The identifier for the transaction.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int | str | None: The transaction identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_id</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;transaction_id&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">buy_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The identifier for the buying transaction.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int | str | None: The buying transaction identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_id</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;buy_id&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sell_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The identifier for the selling transaction.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int | str | None: The selling transaction identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_id</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;sell_id&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">notional</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The notional value of the transaction. Calculated as price * volume * multiplier.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The transaction notional.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">notional</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">notional</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">notional</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span>

        <span class="k">return</span> <span class="n">notional</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">market_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Alias for the transaction price.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The transaction price.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">flow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The flow of the transaction, calculated as side.sign * volume.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The transaction flow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">side</span><span class="o">.</span><span class="n">sign</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span></div>



<div class="viewcode-block" id="TradeData">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.TradeData">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TradeData</span><span class="p">(</span><span class="n">TransactionData</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Alias for `TransactionData` with alternate property names for trade price and volume.</span>

<span class="sd">    This class allows initialization with &#39;trade_price&#39; instead of &#39;price&#39; and &#39;trade_volume&#39; instead of &#39;volume&#39;.</span>
<span class="sd">    It provides additional properties for these alternate names.</span>

<span class="sd">    Properties:</span>
<span class="sd">        trade_price (float): Alias for `price`.</span>
<span class="sd">        trade_volume (float): Alias for `volume`.</span>

<span class="sd">    Methods:</span>
<span class="sd">        from_json(json_message: str | bytes | bytearray | dict) -&gt; TradeData:</span>
<span class="sd">            Creates a `TradeData` instance from a JSON message.</span>

<span class="sd">        from_list(data_list: list[float | int | str | bool]) -&gt; TradeData:</span>
<span class="sd">            Creates a `TradeData` instance from a list of attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TradeData.__init__">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.TradeData.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a new instance of `TradeData`.</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs: Keyword arguments passed to the parent `TransactionData` class.</span>
<span class="sd">                If &#39;trade_price&#39; or &#39;trade_volume&#39; are provided, they are converted to &#39;price&#39; and &#39;volume&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;trade_price&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;trade_price&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;trade_volume&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;trade_volume&#39;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">trade_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Alias for the transaction price.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The transaction price.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">price</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">trade_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Alias for the transaction volume.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The transaction volume.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">volume</span>

<div class="viewcode-block" id="TradeData.from_json">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.TradeData.from_json">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">json_message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span> <span class="o">|</span> <span class="nb">bytearray</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a `TradeData` instance from a JSON message.</span>

<span class="sd">        Args:</span>
<span class="sd">            json_message (str | bytes | bytearray | dict): The JSON message containing trade data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TradeData: A `TradeData` instance.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the JSON message does not match the expected data type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TradeData</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">json_message</span><span class="o">=</span><span class="n">json_message</span><span class="p">)</span></div>


<div class="viewcode-block" id="TradeData.from_buffer">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.TradeData.from_buffer">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_buffer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span> <span class="o">|</span> <span class="nb">memoryview</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TradeData</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span></div>


<div class="viewcode-block" id="TradeData.from_bytes">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.TradeData.from_bytes">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_bytes</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TradeData</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="OrderData">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.OrderData">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OrderData</span><span class="p">(</span><span class="n">MarketData</span><span class="p">):</span>
<div class="viewcode-block" id="OrderData.__init__">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.OrderData.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
            <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">side</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">TransactionSide</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">order_type</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>

        <span class="k">if</span> <span class="s1">&#39;buffer&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;buffer&#39;</span><span class="p">])</span>
            <span class="k">return</span>

        <span class="n">buffer_constructor</span> <span class="o">=</span> <span class="n">_BUFFER_CONSTRUCTOR</span><span class="o">.</span><span class="n">new_order_buffer</span><span class="p">()</span>
        <span class="n">id_size</span> <span class="o">=</span> <span class="n">buffer_constructor</span><span class="o">.</span><span class="n">id_size</span>

        <span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer_constructor</span><span class="p">(</span>
            <span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
            <span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span>
            <span class="n">volume</span><span class="o">=</span><span class="n">volume</span><span class="p">,</span>
            <span class="n">side</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">side</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">side</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">TransactionSide</span><span class="p">(</span><span class="n">side</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="n">order_type</span><span class="o">=</span><span class="n">order_type</span>
        <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">TransactionData</span><span class="o">.</span><span class="n">_set_id</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">order_id</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">id_size</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;OrderData&gt;([</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">market_time</span><span class="si">:</span><span class="s1">%Y-%m-%d %H:%M:%S</span><span class="si">}</span><span class="s1">] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">side</span><span class="o">.</span><span class="n">side_name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s1">, price=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">price</span><span class="si">}</span><span class="s1">, volume=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="si">}</span><span class="s1">)&#39;</span>

<div class="viewcode-block" id="OrderData.from_json">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.OrderData.from_json">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">json_message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span> <span class="o">|</span> <span class="nb">bytearray</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_message</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">json_dict</span> <span class="o">=</span> <span class="n">json_message</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">json_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_message</span><span class="p">)</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="n">json_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dtype mismatch, expect </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">, got </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">json_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="OrderData.from_buffer">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.OrderData.from_buffer">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_buffer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span> <span class="o">|</span> <span class="nb">memoryview</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">price</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">volume</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">price</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">volume</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">volume</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">side</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransactionSide</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TransactionSide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">side</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">OrderType</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderType</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">OrderType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">order_type</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">order_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TransactionData</span><span class="o">.</span><span class="n">_get_id</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;order_id&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">market_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Alias for the transaction price.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The transaction price.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span></div>



<div class="viewcode-block" id="MarketDataBuffer">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketDataBuffer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MarketDataBuffer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">ctype_buffer</span> <span class="o">=</span> <span class="n">_BUFFER_CONSTRUCTOR</span><span class="o">.</span><span class="n">new_market_data_buffer</span><span class="p">()</span>

<div class="viewcode-block" id="MarketDataBuffer.__init__">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketDataBuffer.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span> <span class="o">|</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">Union</span> <span class="o">|</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">RawValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctype_buffer</span><span class="p">)</span> <span class="k">if</span> <span class="n">buffer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">buffer</span></div>


<div class="viewcode-block" id="MarketDataBuffer.to_buffer">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketDataBuffer.to_buffer">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_buffer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">market_data</span><span class="p">:</span> <span class="n">MarketData</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">market_data</span><span class="p">,</span> <span class="n">OrderBook</span><span class="p">):</span>
                <span class="n">buffer</span><span class="o">.</span><span class="n">OrderBook</span> <span class="o">=</span> <span class="n">market_data</span><span class="o">.</span><span class="n">_buffer</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">market_data</span><span class="p">,</span> <span class="p">(</span><span class="n">BarData</span><span class="p">,</span> <span class="n">DailyBar</span><span class="p">)):</span>
                <span class="n">buffer</span><span class="o">.</span><span class="n">BarData</span> <span class="o">=</span> <span class="n">market_data</span><span class="o">.</span><span class="n">_buffer</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">market_data</span><span class="p">,</span> <span class="n">TickData</span><span class="p">):</span>
                <span class="n">buffer</span><span class="o">.</span><span class="n">TickData</span> <span class="o">=</span> <span class="n">market_data</span><span class="o">.</span><span class="n">_buffer</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">market_data</span><span class="p">,</span> <span class="p">(</span><span class="n">TransactionData</span><span class="p">,</span> <span class="n">TradeData</span><span class="p">)):</span>
                <span class="n">buffer</span><span class="o">.</span><span class="n">TransactionData</span> <span class="o">=</span> <span class="n">market_data</span><span class="o">.</span><span class="n">_buffer</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid market_data type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">market_data</span><span class="p">)</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Incompatible types, this might comes from amending Contexts after initialization. Try to clear the cache and run again!&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MarketDataBuffer.from_buffer">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketDataBuffer.from_buffer">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_buffer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderBook</span> <span class="o">|</span> <span class="n">BarData</span> <span class="o">|</span> <span class="n">DailyBar</span> <span class="o">|</span> <span class="n">TickData</span> <span class="o">|</span> <span class="n">TransactionData</span> <span class="o">|</span> <span class="n">TradeData</span> <span class="o">|</span> <span class="n">MarketData</span><span class="p">:</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="n">MarketData</span><span class="o">.</span><span class="n">parse_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">MarketData</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">md</span></div>


<div class="viewcode-block" id="MarketDataBuffer.cast_buffer">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketDataBuffer.cast_buffer">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cast_buffer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderBook</span> <span class="o">|</span> <span class="n">BarData</span> <span class="o">|</span> <span class="n">DailyBar</span> <span class="o">|</span> <span class="n">TickData</span> <span class="o">|</span> <span class="n">TransactionData</span> <span class="o">|</span> <span class="n">TradeData</span> <span class="o">|</span> <span class="n">MarketData</span><span class="p">:</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">MarketData</span><span class="o">.</span><span class="n">cast_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">md</span></div>


<div class="viewcode-block" id="MarketDataBuffer.from_bytes">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketDataBuffer.from_bytes">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_bytes</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderBook</span> <span class="o">|</span> <span class="n">BarData</span> <span class="o">|</span> <span class="n">DailyBar</span> <span class="o">|</span> <span class="n">TickData</span> <span class="o">|</span> <span class="n">TransactionData</span> <span class="o">|</span> <span class="n">TradeData</span> <span class="o">|</span> <span class="n">MarketData</span><span class="p">:</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">MarketData</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">md</span></div>


<div class="viewcode-block" id="MarketDataBuffer.update">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketDataBuffer.update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market_data</span><span class="p">:</span> <span class="n">MarketData</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">market_data</span><span class="o">=</span><span class="n">market_data</span><span class="p">)</span></div>


<div class="viewcode-block" id="MarketDataBuffer.to_market_data">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketDataBuffer.to_market_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_market_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderBook</span> <span class="o">|</span> <span class="n">BarData</span> <span class="o">|</span> <span class="n">DailyBar</span> <span class="o">|</span> <span class="n">TickData</span> <span class="o">|</span> <span class="n">TransactionData</span> <span class="o">|</span> <span class="n">TradeData</span> <span class="o">|</span> <span class="n">MarketData</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cast_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">contents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MarketData</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span></div>



<div class="viewcode-block" id="MarketDataRingBuffer">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketDataRingBuffer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MarketDataRingBuffer</span><span class="p">(</span><span class="n">MarketDataBuffer</span><span class="p">):</span>
<div class="viewcode-block" id="MarketDataRingBuffer.__init__">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketDataRingBuffer.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">condition_put</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;condition_put&#39;</span><span class="p">,</span> <span class="n">Condition</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">condition_get</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;condition_get&#39;</span><span class="p">,</span> <span class="n">Condition</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="n">RawArray</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">RawArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctype_buffer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">))</span></div>


    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">slice</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">MarketDataBuffer</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MarketDataBuffer</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        based on the virtual index, not the internal (actual) index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_slice</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid index </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">. Expected int or slice!&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tail</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">slice</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">MarketDataBuffer</span><span class="p">]:</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">index</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">index</span><span class="o">.</span><span class="n">step</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span> <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MarketDataBuffer</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        the internal method of get will not increase the index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span>
        <span class="k">if</span> <span class="o">-</span><span class="n">valid_length</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">valid_length</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">%</span> <span class="n">valid_length</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Index </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1"> is out of bounds!&#39;</span><span class="p">)</span>

        <span class="n">internal_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">internal_index</span><span class="p">)</span>

<div class="viewcode-block" id="MarketDataRingBuffer.get">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketDataRingBuffer.get">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raise_on_empty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MarketData</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">raise_on_empty</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Buffer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> is empty!&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_get</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">condition_get</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">)</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">to_market_data</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_full</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">condition_put</span><span class="o">.</span><span class="n">notify_all</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">md</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market_data</span><span class="p">:</span> <span class="n">MarketData</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        the internal method of put will not increase the index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tail</span><span class="p">)</span>
        <span class="n">buffer</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">market_data</span><span class="o">=</span><span class="n">market_data</span><span class="p">)</span>

<div class="viewcode-block" id="MarketDataRingBuffer.put">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketDataRingBuffer.put">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market_data</span><span class="p">:</span> <span class="n">MarketData</span><span class="p">,</span> <span class="n">raise_on_full</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        the put method is not thread safe, and should only be called in one single thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_full</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">raise_on_full</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Buffer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> is full!&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_put</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">condition_put</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_put</span><span class="p">(</span><span class="n">market_data</span><span class="o">=</span><span class="n">market_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_get</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tail</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">condition_get</span><span class="o">.</span><span class="n">notify_all</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tail</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="MarketDataRingBuffer.at">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketDataRingBuffer.at">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MarketDataBuffer</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_at</span><span class="p">(</span><span class="n">index</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MarketDataBuffer</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MarketDataBuffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

<div class="viewcode-block" id="MarketDataRingBuffer.is_full">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketDataRingBuffer.is_full">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_full</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">_tail_next</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tail</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">_head_next_circle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>

        <span class="c1"># to be more generic</span>
        <span class="c1"># _tail_next = _tail_next % self.size</span>
        <span class="c1"># _head_next_circle = _head_next_circle % self.size</span>

        <span class="k">return</span> <span class="n">_tail_next</span> <span class="o">==</span> <span class="n">_head_next_circle</span></div>


<div class="viewcode-block" id="MarketDataRingBuffer.is_empty">
<a class="viewcode-back" href="../../../algo_engine.base.html#algo_engine.base.market_utils_nt.MarketDataRingBuffer.is_empty">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">idx_tail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tail</span>
        <span class="n">idx_head</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span>

        <span class="c1"># to be more generic</span>
        <span class="c1"># idx_tail = idx_tail % self.size</span>
        <span class="c1"># idx_head = idx_head % self.size</span>

        <span class="k">return</span> <span class="n">idx_head</span> <span class="o">==</span> <span class="n">idx_tail</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">head</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tail</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@head</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@tail</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>



<span class="c1"># alias of the BarData</span>
<span class="n">CandleStick</span> <span class="o">=</span> <span class="n">BarData</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>